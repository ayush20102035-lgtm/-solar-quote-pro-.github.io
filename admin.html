<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SolarQuote Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;}
input,select,textarea,button{font-family:inherit;}
.login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
.login-box{background:#1e293b;border-radius:16px;padding:32px 28px;width:100%;max-width:360px;border:1px solid #334155;}
.badge{background:#ff6b00;color:white;padding:3px 12px;border-radius:20px;font-size:11px;font-weight:800;display:inline-block;margin-bottom:10px;}
.field{margin-bottom:14px;}
.field label{font-size:12px;color:#94a3b8;display:block;margin-bottom:5px;font-weight:600;}
.field input,.field textarea,.field select{width:100%;padding:11px 13px;border-radius:9px;border:1px solid #334155;font-size:14px;outline:none;background:#0f172a;color:#e2e8f0;}
.field input:focus,.field textarea:focus,.field select:focus{border-color:#ff6b00;}
.btn-primary{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;font-size:14px;font-weight:800;cursor:pointer;}
.btn-primary:disabled{background:#334155;cursor:not-allowed;}
.app{display:none;min-height:100vh;}
nav{background:#1e293b;padding:13px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #334155;position:sticky;top:0;z-index:100;}
.nav-logo{display:flex;align-items:center;gap:10px;}
.nav-sun{width:34px;height:34px;background:#ff6b00;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:17px;}
.tabs{display:flex;background:#1e293b;border-bottom:1px solid #334155;overflow-x:auto;}
.tab{padding:11px 16px;font-size:12px;font-weight:700;color:#64748b;border:none;background:none;cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;}
.tab.active{color:#ff6b00;border-bottom-color:#ff6b00;}
.page{display:none;padding:16px;}
.page.active{display:block;}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-box{background:#1e293b;border-radius:12px;padding:14px 16px;border:1px solid #334155;}
.stat-label{font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.stat-val{font-size:22px;font-weight:800;}
.card{background:#1e293b;border-radius:14px;border:1px solid #334155;margin-bottom:14px;overflow:hidden;}
.card-title{padding:14px 16px;border-bottom:1px solid #334155;font-weight:800;font-size:13px;display:flex;align-items:center;justify-content:space-between;}
.plan-badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:800;}
.plan-free{background:#1c1917;color:#f97316;}
.plan-pro{background:#1e1b4b;color:#818cf8;}
.plan-business{background:#052e16;color:#4ade80;}
.user-item{padding:14px 16px;border-bottom:1px solid #1e293b;}
.user-item:last-child{border-bottom:none;}
.action-btn{padding:5px 12px;border-radius:7px;border:none;font-size:11px;font-weight:700;cursor:pointer;margin-right:4px;margin-top:4px;}
.btn-deact{background:#450a0a;color:#f87171;}
.btn-act{background:#052e16;color:#4ade80;}
select.plan-select{background:#0f172a;color:#e2e8f0;border:1px solid #334155;border-radius:7px;padding:5px 8px;font-size:12px;font-weight:700;cursor:pointer;}
.search-box{width:100%;padding:10px 12px;border-radius:9px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;font-size:13px;outline:none;margin-bottom:12px;}
.search-box:focus{border-color:#ff6b00;}
.toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:9999;padding:11px 20px;border-radius:12px;font-weight:700;font-size:13px;color:white;display:none;box-shadow:0 4px 20px rgba(0,0,0,0.4);white-space:nowrap;}
.toast.show{display:block;}
.empty{text-align:center;padding:40px;color:#64748b;}
/* BAR CHART */
.bar-chart{display:flex;flex-direction:column;gap:8px;padding:16px;}
.bar-row{display:flex;align-items:center;gap:10px;}
.bar-label{font-size:11px;color:#94a3b8;width:60px;flex-shrink:0;text-align:right;}
.bar-track{flex:1;height:20px;background:#0f172a;border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;font-size:11px;font-weight:700;color:white;transition:width 1s;}
.bar-val{font-size:11px;color:#94a3b8;width:70px;flex-shrink:0;}
/* MINI CHART */
.mini-chart{display:flex;align-items:flex-end;gap:4px;height:60px;padding:10px 16px;}
.mini-bar{flex:1;border-radius:3px 3px 0 0;min-height:4px;transition:height 0.8s;}
/* MSG MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal{background:#1e293b;border-radius:18px;padding:24px;width:100%;max-width:420px;border:1px solid #334155;}
.modal h3{font-size:16px;font-weight:800;margin-bottom:16px;}
.revenue-row{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid #1e293b;}
.revenue-row:last-child{border-bottom:none;}
@media(max-width:400px){.stat-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="badge">üîß ADMIN PANEL</div>
    <h2 style="font-size:20px;font-weight:800;margin-bottom:4px;">SolarQuote Pro</h2>
    <div style="font-size:12px;color:#64748b;margin-bottom:20px;">Admin access only</div>
    <div id="loginMsg" style="display:none;padding:10px;border-radius:8px;background:#450a0a;color:#f87171;font-size:13px;font-weight:600;margin-bottom:12px;border:1px solid #7f1d1d;"></div>
    <div class="field"><label>Admin Email</label><input type="email" id="lEmail" placeholder="admin@example.com"/></div>
    <div class="field"><label>Password</label><input type="password" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <button class="btn-primary" id="loginBtn" onclick="doLogin()">üîê Admin Login</button>
  </div>
</div>

<!-- ADMIN APP -->
<div class="app" id="adminApp">
  <nav>
    <div class="nav-logo">
      <div class="nav-sun">üîß</div>
      <div>
        <div style="font-weight:800;font-size:14px;">Admin Panel</div>
        <div style="font-size:10px;color:#64748b;" id="adminEmail">...</div>
      </div>
    </div>
    <button onclick="doLogout()" style="padding:7px 16px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#94a3b8;font-size:12px;font-weight:700;cursor:pointer;">Logout</button>
  </nav>
  <div class="tabs">
    <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
    <button class="tab" onclick="showTab('revenue')">üí∞ Revenue</button>
    <button class="tab" onclick="showTab('analytics')">üìà Analytics</button>
    <button class="tab" onclick="showTab('users')">üë• Users</button>
    <button class="tab" onclick="showTab('messages')">üì¢ Messages</button>
  </div>

  <!-- OVERVIEW -->
  <div class="page active" id="tab-overview">
    <div style="max-width:600px;margin:0 auto;">
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Total Users</div><div class="stat-val" id="ovUsers" style="color:#ff6b00">-</div></div>
        <div class="stat-box"><div class="stat-label">Total Quotes</div><div class="stat-val" id="ovQuotes" style="color:#818cf8">-</div></div>
        <div class="stat-box"><div class="stat-label">Pro/Business</div><div class="stat-val" id="ovPaid" style="color:#4ade80">-</div></div>
        <div class="stat-box"><div class="stat-label">Quotes Today</div><div class="stat-val" id="ovToday" style="color:#fbbf24">-</div></div>
      </div>
      <div class="card">
        <div class="card-title">üìä Plan Distribution</div>
        <div id="planChart" class="bar-chart"></div>
      </div>
      <div class="card">
        <div class="card-title">üïê Recent Signups</div>
        <div id="recentSignups"></div>
      </div>
    </div>
  </div>

  <!-- REVENUE -->
  <div class="page" id="tab-revenue">
    <div style="max-width:600px;margin:0 auto;">
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">MRR (Monthly)</div><div class="stat-val" id="revMRR" style="color:#4ade80;font-size:16px">-</div></div>
        <div class="stat-box"><div class="stat-label">ARR (Annual)</div><div class="stat-val" id="revARR" style="color:#4ade80;font-size:16px">-</div></div>
        <div class="stat-box"><div class="stat-label">Pro Users</div><div class="stat-val" id="revPro" style="color:#818cf8">-</div></div>
        <div class="stat-box"><div class="stat-label">Business Users</div><div class="stat-val" id="revBiz" style="color:#4ade80">-</div></div>
      </div>
      <div class="card">
        <div class="card-title">üí∞ Revenue Breakdown</div>
        <div id="revenueBreakdown"></div>
      </div>
      <div class="card">
        <div class="card-title">üìà Growth Potential</div>
        <div style="padding:16px;">
          <div style="font-size:12px;color:#64748b;margin-bottom:12px;">If free users convert to Pro (‚Çπ799/mo):</div>
          <div id="growthPotential"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ANALYTICS -->
  <div class="page" id="tab-analytics">
    <div style="max-width:600px;margin:0 auto;">
      <div class="card">
        <div class="card-title">üìã Quotes by State</div>
        <div id="stateChart" class="bar-chart"></div>
      </div>
      <div class="card">
        <div class="card-title">‚ö° System Size Distribution</div>
        <div id="sizeChart" class="bar-chart"></div>
      </div>
      <div class="card">
        <div class="card-title">üìä Quote Status Breakdown</div>
        <div id="statusChart" class="bar-chart"></div>
      </div>
      <div class="card">
        <div class="card-title">üìÖ Quotes This Week</div>
        <div style="padding:16px 16px 0;">
          <div class="mini-chart" id="weekChart"></div>
          <div style="display:flex;justify-content:space-around;padding:0 0 12px;font-size:10px;color:#64748b;" id="weekLabels"></div>
        </div>
      </div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Avg System Size</div><div class="stat-val" id="avgKwp" style="color:#ff6b00;font-size:18px">-</div></div>
        <div class="stat-box"><div class="stat-label">Avg Quote Value</div><div class="stat-val" id="avgVal" style="color:#4ade80;font-size:14px">-</div></div>
        <div class="stat-box"><div class="stat-label">Total Pipeline</div><div class="stat-val" id="totalPipe" style="color:#818cf8;font-size:14px">-</div></div>
        <div class="stat-box"><div class="stat-label">Closed Won</div><div class="stat-val" id="closedWon" style="color:#4ade80">-</div></div>
      </div>
    </div>
  </div>

  <!-- USERS -->
  <div class="page" id="tab-users">
    <div style="max-width:700px;margin:0 auto;">
      <input class="search-box" id="userSearch" placeholder="üîç Search by company..." oninput="filterUsers()"/>
      <div class="card">
        <div class="card-title"><span>üë• All Users</span><span id="userCount" style="font-size:12px;color:#64748b;">-</span></div>
        <div id="userList"><div class="empty">Loading...</div></div>
      </div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="page" id="tab-messages">
    <div style="max-width:600px;margin:0 auto;">
      <div class="card">
        <div class="card-title">üì¢ Send Message to User</div>
        <div style="padding:16px;display:flex;flex-direction:column;gap:12px;">
          <div class="field" style="margin:0;">
            <label>Select User</label>
            <select id="msgUser"><option value="">-- Select User --</option></select>
          </div>
          <div class="field" style="margin:0;">
            <label>Or Send to ALL Users</label>
            <select id="msgAll">
              <option value="">Specific user only</option>
              <option value="all">üì¢ All Users</option>
              <option value="free">Free Users only</option>
              <option value="pro">Pro Users only</option>
              <option value="business">Business Users only</option>
            </select>
          </div>
          <div class="field" style="margin:0;"><label>Subject</label><input id="msgSubject" placeholder="Important Update / Offer / Notice..."/></div>
          <div class="field" style="margin:0;"><label>Message</label><textarea id="msgBody" rows="4" placeholder="Type your message here..."></textarea></div>
          <button onclick="sendMessage()" style="padding:12px;border-radius:10px;border:none;background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;font-weight:800;cursor:pointer;font-size:14px;">üì¢ Send Message</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">üì¨ Sent Messages</div>
        <div id="sentMessages"><div class="empty">Loading...</div></div>
      </div>
    </div>
  </div>
</div>

<!-- MSG PREVIEW MODAL -->
<div class="modal-overlay" id="msgModal">
  <div class="modal">
    <h3>üì¢ Message Preview</h3>
    <div id="msgPreview"></div>
    <div style="display:flex;gap:10px;margin-top:16px;">
      <button onclick="confirmSend()" style="flex:1;padding:12px;border-radius:10px;border:none;background:#ff6b00;color:white;font-weight:800;cursor:pointer;">‚úÖ Confirm Send</button>
      <button onclick="document.getElementById('msgModal').classList.remove('show')" style="padding:12px 18px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#94a3b8;font-weight:700;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SB=supabase.createClient('https://sveixtxuascbvoeyxqgl.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2ZWl4dHh1YXNjYnZvZXl4cWdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTI3MDQsImV4cCI6MjA4Nzc2ODcwNH0.t6Bs8weRt4EMjiX0aICArsGaVS6buiakrPST4RVsfHY');

let allUsers=[],allQuotes=[];
const PLANS={free:{price:0,label:'Free'},pro:{price:799,label:'Pro'},business:{price:1999,label:'Business'}};

function inr(n){const a=Math.abs(Math.round(n));const s=a.toString();if(s.length<=3)return(n<0?'-':'')+'‚Çπ'+s;let r=s.slice(-3),m=s.slice(0,-3);while(m.length>2){r=m.slice(-2)+','+r;m=m.slice(0,-2);}return(n<0?'-':'')+'‚Çπ'+m+','+r;}
function showToast(msg,ok=true){const t=document.getElementById('toast');t.textContent=msg;t.style.background=ok?'#16a34a':'#dc2626';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

// AUTH
async function doLogin(){
  const email=document.getElementById('lEmail').value.trim();
  const pass=document.getElementById('lPass').value;
  const msg=document.getElementById('loginMsg');
  if(!email||!pass){msg.style.display='block';msg.textContent='Fill all fields';return;}
  document.getElementById('loginBtn').disabled=true;document.getElementById('loginBtn').textContent='Logging in...';
  const {data,error}=await SB.auth.signInWithPassword({email,password:pass});
  if(error){msg.style.display='block';msg.textContent='Invalid credentials';document.getElementById('loginBtn').disabled=false;document.getElementById('loginBtn').textContent='üîê Admin Login';return;}
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('adminApp').style.display='block';
  document.getElementById('adminEmail').textContent=email;
  loadAll();
}
async function doLogout(){await SB.auth.signOut();document.getElementById('adminApp').style.display='none';document.getElementById('loginScreen').style.display='flex';}
window.onload=async function(){const {data}=await SB.auth.getSession();if(data.session){document.getElementById('loginScreen').style.display='none';document.getElementById('adminApp').style.display='block';document.getElementById('adminEmail').textContent=data.session.user.email;loadAll();}};

// LOAD
async function loadAll(){
  const [{data:u},{data:q}]=await Promise.all([
    SB.from('profiles').select('*').order('created_at',{ascending:false}),
    SB.from('quotes').select('*').order('created_at',{ascending:false})
  ]);
  allUsers=u||[];allQuotes=q||[];
  renderOverview();renderRevenue();renderAnalytics();renderUsers();renderMessages();populateUserSelect();loadSentMessages();
}

// TABS
function showTab(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  const idx={overview:0,revenue:1,analytics:2,users:3,messages:4}[name];
  document.querySelectorAll('.tab')[idx].classList.add('active');
}

// OVERVIEW
function renderOverview(){
  const today=new Date().toDateString();
  const todayQ=allQuotes.filter(q=>new Date(q.created_at).toDateString()===today).length;
  const paid=allUsers.filter(u=>u.plan==='pro'||u.plan==='business').length;
  document.getElementById('ovUsers').textContent=allUsers.length;
  document.getElementById('ovQuotes').textContent=allQuotes.length;
  document.getElementById('ovPaid').textContent=paid;
  document.getElementById('ovToday').textContent=todayQ;
  const plans={free:0,pro:0,business:0};
  allUsers.forEach(u=>plans[u.plan||'free']=(plans[u.plan||'free']||0)+1);
  const max=Math.max(...Object.values(plans),1);
  const colors={free:'#f97316',pro:'#818cf8',business:'#4ade80'};
  document.getElementById('planChart').innerHTML=Object.entries(plans).map(([plan,count])=>`
    <div class="bar-row">
      <div class="bar-label">${plan.charAt(0).toUpperCase()+plan.slice(1)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.round(count/max*100)}%;background:${colors[plan]}">${count}</div></div>
      <div class="bar-val">${count} users</div>
    </div>`).join('');
  document.getElementById('recentSignups').innerHTML=allUsers.slice(0,5).map(u=>`
    <div style="padding:11px 16px;border-bottom:1px solid #334155;display:flex;align-items:center;justify-content:space-between;">
      <div><div style="font-weight:700;font-size:13px;">${u.company_name||'‚Äî'}</div><div style="font-size:11px;color:#64748b;">${u.phone||''} | Joined: ${new Date(u.created_at).toLocaleDateString('en-IN')}</div></div>
      <span class="plan-badge plan-${u.plan||'free'}">${(u.plan||'free').toUpperCase()}</span>
    </div>`).join('');
}

// REVENUE
function renderRevenue(){
  const proCnt=allUsers.filter(u=>u.plan==='pro').length;
  const bizCnt=allUsers.filter(u=>u.plan==='business').length;
  const mrr=proCnt*799+bizCnt*1999;
  const arr=mrr*12;
  document.getElementById('revMRR').textContent=inr(mrr);
  document.getElementById('revARR').textContent=inr(arr);
  document.getElementById('revPro').textContent=proCnt;
  document.getElementById('revBiz').textContent=bizCnt;
  const freeCnt=allUsers.filter(u=>!u.plan||u.plan==='free').length;
  document.getElementById('revenueBreakdown').innerHTML=`
    ${[['Free','free',freeCnt,0,'#f97316'],['Pro','pro',proCnt,799,'#818cf8'],['Business','business',bizCnt,1999,'#4ade80']].map(([label,plan,cnt,price,clr])=>`
    <div class="revenue-row">
      <div><span class="plan-badge plan-${plan}">${label.toUpperCase()}</span><span style="font-size:12px;color:#64748b;margin-left:8px;">${cnt} users √ó ${inr(price)}/mo</span></div>
      <div style="font-size:14px;font-weight:800;color:${clr};">${inr(cnt*price)}</div>
    </div>`).join('')}
    <div class="revenue-row" style="background:#0f172a;">
      <div style="font-weight:800;font-size:14px;">Total MRR</div>
      <div style="font-size:16px;font-weight:800;color:#4ade80;">${inr(mrr)}</div>
    </div>`;
  const convRates=[10,20,30,50];
  document.getElementById('growthPotential').innerHTML=convRates.map(pct=>{
    const converts=Math.round(freeCnt*pct/100);
    const addMrr=converts*799;
    return`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #334155;">
      <div style="font-size:12px;color:#94a3b8;">${pct}% convert (${converts} users)</div>
      <div style="font-weight:800;color:#4ade80;">+${inr(addMrr)}/mo</div>
    </div>`;
  }).join('');
}

// ANALYTICS
function renderAnalytics(){
  // State chart
  const states={};allQuotes.forEach(q=>{const s=q.customer_state||'Unknown';states[s]=(states[s]||0)+1;});
  const sortedStates=Object.entries(states).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxS=Math.max(...sortedStates.map(x=>x[1]),1);
  document.getElementById('stateChart').innerHTML=sortedStates.map(([s,c])=>`
    <div class="bar-row"><div class="bar-label">${s.slice(0,9)}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(c/maxS*100)}%;background:#ff6b00">${c}</div></div><div class="bar-val">${c} quotes</div></div>`).join('') || '<div class="empty">No data yet</div>';

  // Size chart
  const sizes={'1-3 kWp':0,'3-5 kWp':0,'5-10 kWp':0,'10+ kWp':0};
  allQuotes.forEach(q=>{const k=q.system_kwp||0;if(k<=3)sizes['1-3 kWp']++;else if(k<=5)sizes['3-5 kWp']++;else if(k<=10)sizes['5-10 kWp']++;else sizes['10+ kWp']++;});
  const maxSz=Math.max(...Object.values(sizes),1);
  const szColors={'1-3 kWp':'#fbbf24','3-5 kWp':'#f97316','5-10 kWp':'#ff6b00','10+ kWp':'#ea580c'};
  document.getElementById('sizeChart').innerHTML=Object.entries(sizes).map(([s,c])=>`
    <div class="bar-row"><div class="bar-label">${s}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(c/maxSz*100)}%;background:${szColors[s]}">${c}</div></div><div class="bar-val">${c} quotes</div></div>`).join('');

  // Status chart
  const statuses={sent:0,followup:0,closed:0,lost:0};
  allQuotes.forEach(q=>statuses[q.status||'sent']=(statuses[q.status||'sent']||0)+1);
  const maxSt=Math.max(...Object.values(statuses),1);
  const stColors={sent:'#818cf8',followup:'#fbbf24',closed:'#4ade80',lost:'#f87171'};
  const stLabels={sent:'üì§ Sent',followup:'üîî Follow-up',closed:'‚úÖ Closed',lost:'‚ùå Lost'};
  document.getElementById('statusChart').innerHTML=Object.entries(statuses).map(([s,c])=>`
    <div class="bar-row"><div class="bar-label" style="width:70px;">${stLabels[s]}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(c/maxSt*100)}%;background:${stColors[s]}">${c}</div></div><div class="bar-val">${c}</div></div>`).join('');

  // Week chart
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const now=new Date();const weekData=Array(7).fill(0);
  allQuotes.forEach(q=>{const d=new Date(q.created_at);const diff=Math.floor((now-d)/(1000*60*60*24));if(diff<7)weekData[6-diff]++;});
  const maxW=Math.max(...weekData,1);
  const weekDays=Array(7).fill(0).map((_,i)=>{const d=new Date(now);d.setDate(d.getDate()-(6-i));return days[d.getDay()];});
  document.getElementById('weekChart').innerHTML=weekData.map((c,i)=>`<div class="mini-bar" style="height:${Math.max(4,Math.round(c/maxW*50))}px;background:${i===6?'#ff6b00':'#334155'};"></div>`).join('');
  document.getElementById('weekLabels').innerHTML=weekDays.map(d=>`<span>${d}</span>`).join('');

  // Summary stats
  const avgKwp=allQuotes.length?allQuotes.reduce((a,q)=>a+(q.system_kwp||0),0)/allQuotes.length:0;
  const avgVal=allQuotes.length?allQuotes.reduce((a,q)=>a+(q.net_cost||0),0)/allQuotes.length:0;
  const totalPipe=allQuotes.filter(q=>q.status==='sent'||q.status==='followup').reduce((a,q)=>a+(q.net_cost||0),0);
  document.getElementById('avgKwp').textContent=avgKwp?avgKwp.toFixed(1)+' kWp':'‚Äî';
  document.getElementById('avgVal').textContent=avgVal?inr(avgVal):'‚Äî';
  document.getElementById('totalPipe').textContent=totalPipe?inr(totalPipe):'‚Äî';
  document.getElementById('closedWon').textContent=allQuotes.filter(q=>q.status==='closed').length;
}

// USERS
function renderUsers(filter=''){
  const filtered=filter?allUsers.filter(u=>(u.company_name||'').toLowerCase().includes(filter.toLowerCase())||(u.phone||'').includes(filter)):allUsers;
  document.getElementById('userCount').textContent=filtered.length+' users';
  if(!filtered.length){document.getElementById('userList').innerHTML='<div class="empty">No users found</div>';return;}
  document.getElementById('userList').innerHTML=filtered.map(u=>{
    const qCnt=allQuotes.filter(q=>q.user_id===u.id).length;
    const rev=PLANS[u.plan||'free'].price;
    return`<div class="user-item">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;">
        <div>
          <div style="font-weight:700;font-size:14px;">${u.company_name||'No Company'}</div>
          <div style="font-size:11px;color:#64748b;margin-top:2px;">${u.phone||'‚Äî'} ‚Ä¢ ${qCnt} quotes ‚Ä¢ Joined ${new Date(u.created_at).toLocaleDateString('en-IN')}</div>
          ${rev>0?`<div style="font-size:11px;color:#4ade80;margin-top:2px;font-weight:700;">üí∞ ${inr(rev)}/mo</div>`:''}
        </div>
        <div style="text-align:right;">
          <span class="plan-badge plan-${u.plan||'free'}">${(u.plan||'free').toUpperCase()}</span>
          <div style="font-size:10px;color:${u.is_active!==false?'#4ade80':'#f87171'};margin-top:4px;font-weight:700;">${u.is_active!==false?'‚óè Active':'‚óè Inactive'}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;flex-wrap:wrap;gap:6px;">
        <select class="plan-select" onchange="changePlan('${u.id}',this.value)">
          <option value="free" ${(!u.plan||u.plan==='free')?'selected':''}>Free</option>
          <option value="pro" ${u.plan==='pro'?'selected':''}>Pro ‚Çπ799</option>
          <option value="business" ${u.plan==='business'?'selected':''}>Business ‚Çπ1999</option>
        </select>
        <button class="action-btn ${u.is_active!==false?'btn-deact':'btn-act'}" onclick="toggleUser('${u.id}',${u.is_active!==false})">${u.is_active!==false?'üö´ Deactivate':'‚úÖ Activate'}</button>
        <button class="action-btn" style="background:#1e293b;color:#94a3b8;border:1px solid #334155;" onclick="msgUser('${u.id}','${(u.company_name||'').replace(/'/g,'')}')">üì¢ Message</button>
      </div>
    </div>`;
  }).join('');
}
function filterUsers(){renderUsers(document.getElementById('userSearch').value);}

async function changePlan(userId,plan){
  await SB.from('profiles').update({plan}).eq('id',userId);
  allUsers=allUsers.map(u=>u.id===userId?{...u,plan}:u);
  renderUsers(document.getElementById('userSearch').value);
  renderOverview();renderRevenue();
  showToast('‚úÖ Plan ‚Üí '+plan.toUpperCase());
}
async function toggleUser(userId,cur){
  await SB.from('profiles').update({is_active:!cur}).eq('id',userId);
  allUsers=allUsers.map(u=>u.id===userId?{...u,is_active:!cur}:u);
  renderUsers(document.getElementById('userSearch').value);
  showToast(!cur?'‚úÖ Activated!':'üö´ Deactivated!',!cur);
}

// MESSAGES
function populateUserSelect(){
  const sel=document.getElementById('msgUser');
  sel.innerHTML='<option value="">-- Select User --</option>'+allUsers.map(u=>`<option value="${u.id}">${u.company_name||'User'} (${u.plan||'free'})</option>`).join('');
}

function msgUser(userId,name){
  showTab('messages');
  document.getElementById('msgUser').value=userId;
  document.getElementById('msgAll').value='';
  document.getElementById('msgSubject').value='';
  document.getElementById('msgBody').value='';
  document.getElementById('msgSubject').focus();
}

let pendingMsg=null;
function sendMessage(){
  const userId=document.getElementById('msgUser').value;
  const allTarget=document.getElementById('msgAll').value;
  const subject=document.getElementById('msgSubject').value.trim();
  const body=document.getElementById('msgBody').value.trim();
  if(!subject||!body){showToast('Subject & message required!',false);return;}
  if(!userId&&!allTarget){showToast('Select user or target group!',false);return;}
  let targetLabel='';
  if(allTarget==='all')targetLabel='ALL Users ('+allUsers.length+')';
  else if(allTarget==='free')targetLabel='Free Users ('+allUsers.filter(u=>!u.plan||u.plan==='free').length+')';
  else if(allTarget==='pro')targetLabel='Pro Users ('+allUsers.filter(u=>u.plan==='pro').length+')';
  else if(allTarget==='business')targetLabel='Business Users ('+allUsers.filter(u=>u.plan==='business').length+')';
  else{const u=allUsers.find(x=>x.id===userId);targetLabel=u?.company_name||'User';}
  pendingMsg={userId,allTarget,subject,body,targetLabel};
  document.getElementById('msgPreview').innerHTML=`
    <div style="background:#0f172a;border-radius:10px;padding:14px;margin-bottom:12px;">
      <div style="font-size:11px;color:#64748b;margin-bottom:6px;">TO: <b style="color:#e2e8f0;">${targetLabel}</b></div>
      <div style="font-size:11px;color:#64748b;margin-bottom:4px;">SUBJECT:</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:8px;">${subject}</div>
      <div style="font-size:13px;color:#94a3b8;line-height:1.6;">${body}</div>
    </div>`;
  document.getElementById('msgModal').classList.add('show');
}

async function confirmSend(){
  if(!pendingMsg)return;
  document.getElementById('msgModal').classList.remove('show');
  let targets=[];
  if(pendingMsg.allTarget==='all')targets=allUsers.map(u=>u.id);
  else if(pendingMsg.allTarget==='free')targets=allUsers.filter(u=>!u.plan||u.plan==='free').map(u=>u.id);
  else if(pendingMsg.allTarget==='pro')targets=allUsers.filter(u=>u.plan==='pro').map(u=>u.id);
  else if(pendingMsg.allTarget==='business')targets=allUsers.filter(u=>u.plan==='business').map(u=>u.id);
  else targets=[pendingMsg.userId];

  // Save to admin_messages table
  try{
    const rows=targets.map(uid=>({user_id:uid,subject:pendingMsg.subject,body:pendingMsg.body}));
    await SB.from('admin_messages').insert(rows);
    showToast('‚úÖ Sent to '+targets.length+' user(s)!');
    document.getElementById('msgSubject').value='';
    document.getElementById('msgBody').value='';
    loadSentMessages();
  }catch(e){
    showToast('Error! Create admin_messages table first.',false);
  }
  pendingMsg=null;
}

async function loadSentMessages(){
  try{
    const {data:msgs}=await SB.from('admin_messages').select('*').order('created_at',{ascending:false}).limit(20);
    if(!msgs||!msgs.length){document.getElementById('sentMessages').innerHTML='<div class="empty">No messages sent yet</div>';return;}
    document.getElementById('sentMessages').innerHTML=msgs.map(m=>`
      <div style="padding:12px 16px;border-bottom:1px solid #334155;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:700;font-size:13px;">${m.subject}</div>
          <div style="font-size:10px;color:#64748b;">${new Date(m.created_at).toLocaleDateString('en-IN')}</div>
        </div>
        <div style="font-size:12px;color:#64748b;margin-top:4px;">${m.body.slice(0,80)}${m.body.length>80?'...':''}</div>
      </div>`).join('');
  }catch(e){document.getElementById('sentMessages').innerHTML='<div class="empty">Create admin_messages table to use this feature</div>';}
}

function renderMessages(){populateUserSelect();}
</script>
</body>
</html>
