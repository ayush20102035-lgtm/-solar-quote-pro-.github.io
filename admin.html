<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SolarQuote Admin ‚Äî Ayush</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0a0f1e;color:#e2e8f0;min-height:100vh;}
input,select,textarea,button{font-family:inherit;}
/* LOGIN */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#0a0f1e,#1a1f3e);}
.login-box{background:#111827;border-radius:20px;padding:36px 28px;width:100%;max-width:360px;border:1px solid #1f2937;box-shadow:0 20px 60px rgba(0,0,0,0.5);}
.admin-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;padding:4px 14px;border-radius:20px;font-size:11px;font-weight:800;letter-spacing:1px;margin-bottom:14px;}
.lfield{margin-bottom:14px;}
.lfield label{font-size:12px;color:#6b7280;display:block;margin-bottom:5px;font-weight:600;}
.lfield input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #1f2937;font-size:14px;outline:none;background:#0a0f1e;color:#e2e8f0;transition:border-color 0.2s;}
.lfield input:focus{border-color:#ff6b00;}
.btn-login{width:100%;padding:13px;border-radius:11px;border:none;background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;font-size:15px;font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(255,107,0,0.3);}
.btn-login:disabled{background:#374151;box-shadow:none;cursor:not-allowed;}
.err-box{padding:10px 14px;border-radius:8px;font-size:13px;font-weight:600;margin-bottom:14px;background:#450a0a;color:#f87171;border:1px solid #7f1d1d;display:none;}
/* APP */
.app{display:none;min-height:100vh;background:#0a0f1e;}
/* TOPBAR */
.topbar{background:#111827;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #1f2937;position:sticky;top:0;z-index:100;}
.logo-area{display:flex;align-items:center;gap:10px;}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,#ff6b00,#ff9500);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo-text{font-weight:800;font-size:14px;line-height:1.1;}
.logo-sub{font-size:10px;color:#6b7280;}
.owner-badge{background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:800;}
/* TABS */
.tab-bar{display:flex;background:#111827;border-bottom:1px solid #1f2937;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.tab-btn{padding:12px 16px;font-size:12px;font-weight:700;color:#6b7280;border:none;background:none;cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all 0.2s;}
.tab-btn.active{color:#ff6b00;border-bottom-color:#ff6b00;}
/* PAGES */
.page{display:none;padding:16px;max-width:700px;margin:0 auto;}
.page.active{display:block;}
/* CARDS */
.card{background:#111827;border-radius:16px;border:1px solid #1f2937;margin-bottom:14px;overflow:hidden;}
.card-header{padding:14px 16px;border-bottom:1px solid #1f2937;display:flex;align-items:center;justify-content:space-between;}
.card-title{font-weight:800;font-size:13px;display:flex;align-items:center;gap:8px;}
/* STATS */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-card{background:#111827;border-radius:14px;padding:16px;border:1px solid #1f2937;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.stat-card.orange::before{background:linear-gradient(90deg,#ff6b00,#ff9500);}
.stat-card.blue::before{background:linear-gradient(90deg,#3b82f6,#8b5cf6);}
.stat-card.green::before{background:linear-gradient(90deg,#10b981,#34d399);}
.stat-card.yellow::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
.stat-label{font-size:10px;color:#6b7280;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
.stat-val{font-size:24px;font-weight:800;line-height:1;}
.stat-sub{font-size:11px;color:#4b5563;margin-top:4px;}
/* PLAN BADGES */
.badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:800;}
.b-free{background:#1c1917;color:#f97316;}
.b-pro{background:#1e1b4b;color:#818cf8;}
.b-business{background:#052e16;color:#4ade80;}
/* USERS */
.user-row{padding:14px 16px;border-bottom:1px solid #1f2937;}
.user-row:last-child{border-bottom:none;}
.user-name{font-weight:700;font-size:14px;margin-bottom:3px;}
.user-meta{font-size:11px;color:#6b7280;margin-bottom:8px;line-height:1.8;}
.user-actions{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
.act-btn{padding:6px 12px;border-radius:8px;border:none;font-size:11px;font-weight:700;cursor:pointer;}
.act-deact{background:#450a0a;color:#f87171;}
.act-activ{background:#052e16;color:#4ade80;}
.act-msg{background:#1e1b4b;color:#818cf8;}
.plan-sel{background:#0a0f1e;color:#e2e8f0;border:1px solid #374151;border-radius:8px;padding:6px 10px;font-size:12px;font-weight:700;cursor:pointer;outline:none;}
/* QUOTES LIST */
.q-row{padding:14px 16px;border-bottom:1px solid #1f2937;}
.q-row:last-child{border-bottom:none;}
/* BAR CHART */
.bar-chart{padding:14px 16px;display:flex;flex-direction:column;gap:10px;}
.bar-row{display:flex;align-items:center;gap:10px;}
.bar-lbl{font-size:11px;color:#6b7280;width:75px;flex-shrink:0;text-align:right;}
.bar-track{flex:1;height:22px;background:#0a0f1e;border-radius:6px;overflow:hidden;}
.bar-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding-left:10px;font-size:11px;font-weight:800;color:white;transition:width 1s ease;}
.bar-num{font-size:11px;color:#6b7280;width:60px;flex-shrink:0;}
/* WEEK CHART */
.week-wrap{padding:14px 16px;}
.week-bars{display:flex;align-items:flex-end;gap:5px;height:70px;margin-bottom:6px;}
.week-bar{flex:1;border-radius:4px 4px 0 0;min-height:4px;transition:height 0.8s;}
.week-days{display:flex;gap:5px;}
.week-day{flex:1;text-align:center;font-size:10px;color:#6b7280;}
/* REVENUE */
.rev-row{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2937;}
.rev-row:last-child{border-bottom:none;}
.rev-row.total{background:#0a0f1e;}
/* SEARCH */
.search-inp{width:100%;padding:10px 14px;border-radius:10px;border:1px solid #1f2937;background:#0a0f1e;color:#e2e8f0;font-size:13px;outline:none;margin-bottom:12px;}
.search-inp:focus{border-color:#ff6b00;}
/* MSG */
.msg-field{margin-bottom:12px;}
.msg-field label{font-size:12px;color:#6b7280;display:block;margin-bottom:5px;font-weight:600;}
.msg-field input,.msg-field select,.msg-field textarea{width:100%;padding:10px 13px;border-radius:9px;border:1px solid #1f2937;font-size:13px;outline:none;background:#0a0f1e;color:#e2e8f0;}
.msg-field input:focus,.msg-field select:focus,.msg-field textarea:focus{border-color:#ff6b00;}
.btn-send{width:100%;padding:13px;border-radius:11px;border:none;background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;font-size:14px;font-weight:800;cursor:pointer;}
.sent-msg{padding:12px 16px;border-bottom:1px solid #1f2937;}
.sent-msg:last-child{border-bottom:none;}
/* MODAL */
.modal-over{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-over.show{display:flex;}
.modal-box{background:#111827;border-radius:18px;padding:24px;width:100%;max-width:400px;border:1px solid #1f2937;}
/* TOAST */
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:999;padding:12px 22px;border-radius:12px;font-weight:800;font-size:13px;color:white;display:none;white-space:nowrap;box-shadow:0 4px 24px rgba(0,0,0,0.5);}
.toast.show{display:block;}
.empty{text-align:center;padding:40px;color:#4b5563;}
@media(max-width:380px){.stat-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <div class="admin-badge">üîß OWNER PANEL</div>
    <h2 style="font-size:22px;font-weight:800;margin-bottom:4px;">SolarQuote Pro</h2>
    <p style="font-size:12px;color:#6b7280;margin-bottom:20px;">Owner access only ‚Äî Ayush</p>
    <div class="err-box" id="loginErr"></div>
    <div class="lfield"><label>Email</label><input type="email" id="lEmail" placeholder="ayush20102035@gmail.com"/></div>
    <div class="lfield"><label>Password</label><input type="password" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <button class="btn-login" id="loginBtn" onclick="doLogin()">üîê Owner Login</button>
    <div style="text-align:center;margin-top:14px;font-size:11px;color:#374151;">üîí Restricted to owner only</div>
  </div>
</div>

<!-- APP -->
<div class="app" id="adminApp">
  <div class="topbar">
    <div class="logo-area">
      <div class="logo-icon">‚òÄ</div>
      <div>
        <div class="logo-text">Admin Panel</div>
        <div class="logo-sub">SolarQuote Pro ‚Äî Owner</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="owner-badge">üëë Ayush</span>
      <button onclick="doLogout()" style="padding:7px 12px;border-radius:8px;border:1px solid #1f2937;background:#0a0f1e;color:#6b7280;font-size:12px;font-weight:700;cursor:pointer;">Logout</button>
    </div>
  </div>

  <div class="tab-bar">
    <button class="tab-btn active" onclick="showTab('overview')">üìä Overview</button>
    <button class="tab-btn" onclick="showTab('revenue')">üí∞ Revenue</button>
    <button class="tab-btn" onclick="showTab('analytics')">üìà Analytics</button>
    <button class="tab-btn" onclick="showTab('users')">üë• Users</button>
    <button class="tab-btn" onclick="showTab('allquotes')">üìã Quotes</button>
    <button class="tab-btn" onclick="showTab('messages')">üì¢ Messages</button>
  </div>

  <!-- OVERVIEW -->
  <div class="page active" id="tab-overview">
    <div style="margin-bottom:12px;padding:14px 16px;background:#111827;border-radius:14px;border:1px solid #1f2937;display:flex;align-items:center;gap:12px;">
      <div style="font-size:28px;">üëë</div>
      <div>
        <div style="font-weight:800;font-size:14px;">Welcome back, Ayush!</div>
        <div style="font-size:12px;color:#6b7280;margin-top:2px;" id="ovDate">Loading...</div>
      </div>
    </div>
    <div class="stat-grid">
      <div class="stat-card orange"><div class="stat-label">Total Users</div><div class="stat-val" id="ovUsers" style="color:#ff6b00">‚Äî</div><div class="stat-sub">Registered installers</div></div>
      <div class="stat-card blue"><div class="stat-label">Total Quotes</div><div class="stat-val" id="ovQuotes" style="color:#818cf8">‚Äî</div><div class="stat-sub">All time</div></div>
      <div class="stat-card green"><div class="stat-label">Paid Users</div><div class="stat-val" id="ovPaid" style="color:#4ade80">‚Äî</div><div class="stat-sub">Pro + Business</div></div>
      <div class="stat-card yellow"><div class="stat-label">Today's Quotes</div><div class="stat-val" id="ovToday" style="color:#fbbf24">‚Äî</div><div class="stat-sub">Generated today</div></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üìä Plan Distribution</div></div>
      <div id="planChart" class="bar-chart"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üïê Latest Signups</div><span id="signupCount" style="font-size:12px;color:#6b7280;"></span></div>
      <div id="recentSignups"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üìã Latest Quotes</div></div>
      <div id="recentQuotes"></div>
    </div>
  </div>

  <!-- REVENUE -->
  <div class="page" id="tab-revenue">
    <div class="stat-grid">
      <div class="stat-card green"><div class="stat-label">MRR</div><div class="stat-val" id="revMRR" style="color:#4ade80;font-size:18px">‚Äî</div><div class="stat-sub">Monthly Revenue</div></div>
      <div class="stat-card green"><div class="stat-label">ARR</div><div class="stat-val" id="revARR" style="color:#4ade80;font-size:18px">‚Äî</div><div class="stat-sub">Annual Revenue</div></div>
      <div class="stat-card blue"><div class="stat-label">Pro Users</div><div class="stat-val" id="revPro" style="color:#818cf8">‚Äî</div><div class="stat-sub">‚Çπ799/month each</div></div>
      <div class="stat-card yellow"><div class="stat-label">Business Users</div><div class="stat-val" id="revBiz" style="color:#fbbf24">‚Äî</div><div class="stat-sub">‚Çπ1999/month each</div></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üí∞ Revenue Breakdown</div></div>
      <div id="revBreakdown"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üöÄ Growth Potential</div></div>
      <div style="padding:14px 16px;">
        <div style="font-size:12px;color:#6b7280;margin-bottom:12px;">If free users convert to Pro (‚Çπ799/mo):</div>
        <div id="growthCalc"></div>
      </div>
    </div>
    <div class="card" style="border-color:#ff6b00;">
      <div class="card-header" style="background:linear-gradient(135deg,#1a0a00,#2a1000);border-bottom-color:#ff6b00;">
        <div class="card-title" style="color:#ff6b00;">üí° Revenue Tips</div>
      </div>
      <div style="padding:14px 16px;font-size:12px;color:#9ca3af;line-height:2;">
        ‚Ä¢ WhatsApp free users about Pro plan benefits<br/>
        ‚Ä¢ Offer 1 month free trial to convert<br/>
        ‚Ä¢ Business plan = unlimited quotes + priority support<br/>
        ‚Ä¢ Target high-volume installers (10+ quotes/month)
      </div>
    </div>
  </div>

  <!-- ANALYTICS -->
  <div class="page" id="tab-analytics">
    <div class="stat-grid">
      <div class="stat-card orange"><div class="stat-label">Avg System Size</div><div class="stat-val" id="avgKwp" style="color:#ff6b00;font-size:18px">‚Äî</div><div class="stat-sub">kWp per quote</div></div>
      <div class="stat-card green"><div class="stat-label">Avg Quote Value</div><div class="stat-val" id="avgVal" style="color:#4ade80;font-size:16px">‚Äî</div><div class="stat-sub">Net cost avg</div></div>
      <div class="stat-card blue"><div class="stat-label">Pipeline Value</div><div class="stat-val" id="pipeVal" style="color:#818cf8;font-size:16px">‚Äî</div><div class="stat-sub">Open quotes</div></div>
      <div class="stat-card yellow"><div class="stat-label">Won Deals</div><div class="stat-val" id="wonDeals" style="color:#fbbf24">‚Äî</div><div class="stat-sub">Closed status</div></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üìÖ Quotes This Week</div></div>
      <div class="week-wrap">
        <div class="week-bars" id="weekBars"></div>
        <div class="week-days" id="weekDays"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üó∫ Top States</div></div>
      <div id="stateChart" class="bar-chart"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">‚ö° System Size Distribution</div></div>
      <div id="sizeChart" class="bar-chart"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üìä Quote Status Breakdown</div></div>
      <div id="statusChart" class="bar-chart"></div>
    </div>
  </div>

  <!-- USERS -->
  <div class="page" id="tab-users">
    <input class="search-inp" id="userSearch" placeholder="üîç Search by company or phone..." oninput="filterUsers()"/>
    <div class="card">
      <div class="card-header">
        <div class="card-title">üë• All Users</div>
        <span id="userCount" style="font-size:12px;color:#6b7280;">‚Äî</span>
      </div>
      <div id="userList"><div class="empty">Loading...</div></div>
    </div>
  </div>

  <!-- ALL QUOTES -->
  <div class="page" id="tab-allquotes">
    <div class="card">
      <div class="card-header">
        <div class="card-title">üìã All Quotes</div>
        <span id="qtotal" style="font-size:12px;color:#6b7280;">‚Äî</span>
      </div>
      <div id="allQuotesList"><div class="empty">Loading...</div></div>
    </div>
  </div>

  <!-- MESSAGES -->
  <div class="page" id="tab-messages">
    <div class="card">
      <div class="card-header"><div class="card-title">üì¢ Send Message to Users</div></div>
      <div style="padding:16px;display:flex;flex-direction:column;gap:12px;">
        <div class="msg-field">
          <label>Target Audience</label>
          <select id="msgTarget">
            <option value="all">üì¢ All Users</option>
            <option value="free">üü† Free Users Only</option>
            <option value="pro">üü£ Pro Users Only</option>
            <option value="business">üü¢ Business Users Only</option>
            <option value="one">üë§ Specific User</option>
          </select>
        </div>
        <div class="msg-field" id="specificUserDiv" style="display:none;">
          <label>Select User</label>
          <select id="msgUser"><option value="">-- Select --</option></select>
        </div>
        <div class="msg-field"><label>Subject / Title</label><input id="msgSubject" placeholder="New Feature / Important Update / Offer..."/></div>
        <div class="msg-field"><label>Message Body</label><textarea id="msgBody" rows="4" placeholder="Write your message here..."></textarea></div>
        <button class="btn-send" onclick="previewMsg()">üì¢ Preview & Send</button>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üì¨ Sent Messages</div></div>
      <div id="sentMsgs"><div class="empty">Loading...</div></div>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-over" id="confirmModal">
  <div class="modal-box">
    <h3 style="font-size:16px;font-weight:800;margin-bottom:14px;">üì¢ Confirm Send</h3>
    <div id="modalPreview" style="background:#0a0f1e;border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;line-height:1.7;"></div>
    <div style="display:flex;gap:10px;">
      <button onclick="confirmSend()" style="flex:1;padding:12px;border-radius:10px;border:none;background:#ff6b00;color:white;font-weight:800;cursor:pointer;">‚úÖ Send Now</button>
      <button onclick="document.getElementById('confirmModal').classList.remove('show')" style="padding:12px 16px;border-radius:10px;border:1px solid #374151;background:#0a0f1e;color:#9ca3af;font-weight:700;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const ADMIN_EMAIL='ayush20102035@gmail.com';
const SB=supabase.createClient('https://sveixtxuascbvoeyxqgl.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2ZWl4dHh1YXNjYnZvZXl4cWdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTI3MDQsImV4cCI6MjA4Nzc2ODcwNH0.t6Bs8weRt4EMjiX0aICArsGaVS6buiakrPST4RVsfHY');
let AU=[],AQ=[];
const PRICES={free:0,pro:799,business:1999};

function inr(n){if(!n)return'‚Çπ0';const a=Math.abs(Math.round(n));const s=a.toString();if(s.length<=3)return'‚Çπ'+s;let r=s.slice(-3),m=s.slice(0,-3);while(m.length>2){r=m.slice(-2)+','+r;m=m.slice(0,-2);}return'‚Çπ'+m+','+r;}
function showToast(msg,ok=true){const t=document.getElementById('toast');t.textContent=msg;t.style.background=ok?'#16a34a':'#dc2626';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
function fmtDate(d){return new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}

// LOGIN ‚Äî only allow admin email
async function doLogin(){
  const email=document.getElementById('lEmail').value.trim().toLowerCase();
  const pass=document.getElementById('lPass').value;
  const err=document.getElementById('loginErr');
  // Block non-admin
  if(email!==ADMIN_EMAIL){err.style.display='block';err.textContent='‚õî Access denied. Owner only.';return;}
  if(!pass){err.style.display='block';err.textContent='Enter password';return;}
  document.getElementById('loginBtn').disabled=true;document.getElementById('loginBtn').textContent='Verifying...';
  const {data,error}=await SB.auth.signInWithPassword({email,password:pass});
  if(error){err.style.display='block';err.textContent='Invalid credentials';document.getElementById('loginBtn').disabled=false;document.getElementById('loginBtn').textContent='üîê Owner Login';return;}
  // Double check email
  if(data.user.email!==ADMIN_EMAIL){await SB.auth.signOut();err.style.display='block';err.textContent='‚õî Access denied';document.getElementById('loginBtn').disabled=false;document.getElementById('loginBtn').textContent='üîê Owner Login';return;}
  startApp();
}
async function doLogout(){await SB.auth.signOut();document.getElementById('adminApp').style.display='none';document.getElementById('loginWrap').style.display='flex';}
window.onload=async()=>{
  const {data}=await SB.auth.getSession();
  if(data.session&&data.session.user.email===ADMIN_EMAIL){startApp();}
};

async function startApp(){
  document.getElementById('loginWrap').style.display='none';
  document.getElementById('adminApp').style.display='block';
  document.getElementById('ovDate').textContent='Today: '+new Date().toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  // Message target toggle
  document.getElementById('msgTarget').onchange=function(){document.getElementById('specificUserDiv').style.display=this.value==='one'?'block':'none';};
  await loadAll();
}

async function loadAll(){
  const [{data:u},{data:q}]=await Promise.all([
    SB.from('profiles').select('*').order('created_at',{ascending:false}),
    SB.from('quotes').select('*').order('created_at',{ascending:false})
  ]);
  AU=u||[];AQ=q||[];
  renderOverview();renderRevenue();renderAnalytics();renderUsers();renderAllQuotes();populateUserSel();loadSentMsgs();
}

// TABS
function showTab(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  const idx={overview:0,revenue:1,analytics:2,users:3,allquotes:4,messages:5}[name];
  document.querySelectorAll('.tab-btn')[idx].classList.add('active');
}

// OVERVIEW
function renderOverview(){
  const today=new Date().toDateString();
  const todayQ=AQ.filter(q=>new Date(q.created_at).toDateString()===today).length;
  const paid=AU.filter(u=>u.plan==='pro'||u.plan==='business').length;
  document.getElementById('ovUsers').textContent=AU.length;
  document.getElementById('ovQuotes').textContent=AQ.length;
  document.getElementById('ovPaid').textContent=paid;
  document.getElementById('ovToday').textContent=todayQ;
  // Plan chart
  const plans={free:0,pro:0,business:0};AU.forEach(u=>plans[u.plan||'free']=(plans[u.plan||'free']||0)+1);
  const maxP=Math.max(...Object.values(plans),1);
  const clrs={free:'#f97316',pro:'#818cf8',business:'#4ade80'};
  document.getElementById('planChart').innerHTML=Object.entries(plans).map(([p,c])=>`
    <div class="bar-row">
      <div class="bar-lbl">${p.charAt(0).toUpperCase()+p.slice(1)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.max(4,Math.round(c/maxP*100))}%;background:${clrs[p]};">${c}</div></div>
      <div class="bar-num">${c} users</div>
    </div>`).join('');
  // Recent signups
  document.getElementById('signupCount').textContent=AU.length+' total';
  document.getElementById('recentSignups').innerHTML=AU.slice(0,5).map(u=>`
    <div style="padding:12px 16px;border-bottom:1px solid #1f2937;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <div style="font-weight:700;font-size:13px;">${u.company_name||'‚Äî'}</div>
        <div style="font-size:11px;color:#6b7280;">${u.phone||'‚Äî'} ‚Ä¢ ${fmtDate(u.created_at)}</div>
        <div style="font-size:11px;color:#6b7280;">${AQ.filter(q=>q.user_id===u.id).length} quotes generated</div>
      </div>
      <span class="badge b-${u.plan||'free'}">${(u.plan||'free').toUpperCase()}</span>
    </div>`).join('');
  // Recent quotes
  document.getElementById('recentQuotes').innerHTML=AQ.slice(0,5).map(q=>{
    const u=AU.find(x=>x.id===q.user_id);
    return`<div style="padding:12px 16px;border-bottom:1px solid #1f2937;">
      <div style="display:flex;justify-content:space-between;">
        <div style="font-weight:700;font-size:13px;">${q.customer_name||'‚Äî'}</div>
        <div style="font-size:13px;font-weight:800;color:#ff6b00;">${q.system_kwp} kWp</div>
      </div>
      <div style="font-size:11px;color:#6b7280;">${q.customer_state} ‚Ä¢ ${fmtDate(q.created_at)} ‚Ä¢ by ${u?.company_name||'Unknown'}</div>
      <div style="font-size:12px;font-weight:700;color:#4ade80;margin-top:3px;">${inr(q.net_cost)}</div>
    </div>`;}).join('');
}

// REVENUE
function renderRevenue(){
  const pro=AU.filter(u=>u.plan==='pro').length;
  const biz=AU.filter(u=>u.plan==='business').length;
  const free=AU.filter(u=>!u.plan||u.plan==='free').length;
  const mrr=pro*799+biz*1999;
  document.getElementById('revMRR').textContent=inr(mrr);
  document.getElementById('revARR').textContent=inr(mrr*12);
  document.getElementById('revPro').textContent=pro;
  document.getElementById('revBiz').textContent=biz;
  document.getElementById('revBreakdown').innerHTML=`
    <div class="rev-row"><div><span class="badge b-free">FREE</span><span style="font-size:12px;color:#6b7280;margin-left:8px;">${free} √ó ‚Çπ0</span></div><div style="font-weight:700;color:#6b7280;">‚Çπ0</div></div>
    <div class="rev-row"><div><span class="badge b-pro">PRO</span><span style="font-size:12px;color:#6b7280;margin-left:8px;">${pro} √ó ‚Çπ799/mo</span></div><div style="font-weight:700;color:#818cf8;">${inr(pro*799)}</div></div>
    <div class="rev-row"><div><span class="badge b-business">BUSINESS</span><span style="font-size:12px;color:#6b7280;margin-left:8px;">${biz} √ó ‚Çπ1999/mo</span></div><div style="font-weight:700;color:#4ade80;">${inr(biz*1999)}</div></div>
    <div class="rev-row total"><div style="font-weight:800;font-size:15px;">Total MRR</div><div style="font-size:18px;font-weight:800;color:#4ade80;">${inr(mrr)}</div></div>`;
  document.getElementById('growthCalc').innerHTML=[10,20,30,50].map(pct=>{
    const n=Math.round(free*pct/100);
    return`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #1f2937;">
      <div style="font-size:12px;color:#9ca3af;">${pct}% convert (${n} users)</div>
      <div style="font-weight:800;color:#4ade80;">+${inr(n*799)}/mo</div>
    </div>`;}).join('');
}

// ANALYTICS
function renderAnalytics(){
  const today=new Date();
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const weekData=Array(7).fill(0);
  AQ.forEach(q=>{const d=new Date(q.created_at);const diff=Math.floor((today-d)/(864e5));if(diff<7)weekData[6-diff]++;});
  const maxW=Math.max(...weekData,1);
  const wDays=Array(7).fill(0).map((_,i)=>{const d=new Date(today);d.setDate(d.getDate()-(6-i));return days[d.getDay()];});
  document.getElementById('weekBars').innerHTML=weekData.map((c,i)=>`<div class="week-bar" style="height:${Math.max(4,Math.round(c/maxW*60))}px;background:${i===6?'#ff6b00':'#1f2937'};"></div>`).join('');
  document.getElementById('weekDays').innerHTML=wDays.map(d=>`<div class="week-day">${d}</div>`).join('');
  // Stats
  const avgKwp=AQ.length?(AQ.reduce((a,q)=>a+(q.system_kwp||0),0)/AQ.length).toFixed(1)+'kWp':'‚Äî';
  const avgVal=AQ.length?inr(AQ.reduce((a,q)=>a+(q.net_cost||0),0)/AQ.length):'‚Äî';
  const pipe=AQ.filter(q=>q.status==='sent'||q.status==='followup').reduce((a,q)=>a+(q.net_cost||0),0);
  document.getElementById('avgKwp').textContent=avgKwp;
  document.getElementById('avgVal').textContent=avgVal;
  document.getElementById('pipeVal').textContent=inr(pipe);
  document.getElementById('wonDeals').textContent=AQ.filter(q=>q.status==='closed').length;
  // State chart
  const states={};AQ.forEach(q=>{const s=q.customer_state||'Unknown';states[s]=(states[s]||0)+1;});
  const topStates=Object.entries(states).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxS=Math.max(...topStates.map(x=>x[1]),1);
  document.getElementById('stateChart').innerHTML=topStates.length?topStates.map(([s,c])=>`
    <div class="bar-row"><div class="bar-lbl">${s.slice(0,10)}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(4,Math.round(c/maxS*100))}%;background:#ff6b00;">${c}</div></div><div class="bar-num">${c}</div></div>`).join(''):'<div class="empty">No quote data yet</div>';
  // Size
  const sz={'1-3kWp':0,'3-5kWp':0,'5-10kWp':0,'10+kWp':0};
  AQ.forEach(q=>{const k=q.system_kwp||0;if(k<=3)sz['1-3kWp']++;else if(k<=5)sz['3-5kWp']++;else if(k<=10)sz['5-10kWp']++;else sz['10+kWp']++;});
  const maxSz=Math.max(...Object.values(sz),1);
  const szC={'1-3kWp':'#fbbf24','3-5kWp':'#f97316','5-10kWp':'#ff6b00','10+kWp':'#ea580c'};
  document.getElementById('sizeChart').innerHTML=Object.entries(sz).map(([s,c])=>`
    <div class="bar-row"><div class="bar-lbl">${s}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(4,Math.round(c/maxSz*100))}%;background:${szC[s]};">${c}</div></div><div class="bar-num">${c}</div></div>`).join('');
  // Status
  const st={sent:0,followup:0,closed:0,lost:0};AQ.forEach(q=>st[q.status||'sent']=(st[q.status||'sent']||0)+1);
  const maxSt=Math.max(...Object.values(st),1);
  const stC={sent:'#818cf8',followup:'#fbbf24',closed:'#4ade80',lost:'#f87171'};
  const stL={sent:'üì§ Sent',followup:'üîî Followup',closed:'‚úÖ Closed',lost:'‚ùå Lost'};
  document.getElementById('statusChart').innerHTML=Object.entries(st).map(([s,c])=>`
    <div class="bar-row"><div class="bar-lbl" style="width:80px;">${stL[s]}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.max(4,Math.round(c/maxSt*100))}%;background:${stC[s]};">${c}</div></div><div class="bar-num">${c}</div></div>`).join('');
}

// USERS
function renderUsers(filter=''){
  const f=filter.toLowerCase();
  const list=f?AU.filter(u=>(u.company_name||'').toLowerCase().includes(f)||(u.phone||'').includes(f)):AU;
  document.getElementById('userCount').textContent=list.length+' users';
  if(!list.length){document.getElementById('userList').innerHTML='<div class="empty">No users found</div>';return;}
  document.getElementById('userList').innerHTML=list.map(u=>{
    const qc=AQ.filter(q=>q.user_id===u.id).length;
    const rev=PRICES[u.plan||'free'];
    const plan=u.plan||'free';
    const exp=u.subscription_expires_at?new Date(u.subscription_expires_at):null;
    const now=new Date();
    const daysLeft=exp?Math.ceil((exp-now)/(1000*60*60*24)):null;
    const isExpired=exp&&exp<now;
    const expColor=isExpired?'#f87171':daysLeft<=7?'#fbbf24':'#4ade80';
    let expiryHtml='';
    if(plan!=='free'&&exp){
      expiryHtml=`<br/><span style="font-size:11px;font-weight:800;color:${expColor};">
        ${isExpired?'‚ö†Ô∏è EXPIRED: '+fmtDate(exp):daysLeft<=7?'‚ö†Ô∏è Expires in '+daysLeft+' days ('+fmtDate(exp)+')':'‚úÖ Expires: '+fmtDate(exp)}
      </span>`;
    }
    return`<div class="user-row" style="${isExpired?'border-left:3px solid #f87171;':''}">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:6px;">
        <div style="flex:1;">
          <div class="user-name">${u.company_name||'No Company'}</div>
          <div class="user-meta">
            üì± ${u.phone||'‚Äî'}<br/>
            üìã ${qc} quotes generated<br/>
            üìÖ Joined: ${fmtDate(u.created_at)}<br/>
            ${u.last_active?'üïê Last active: '+fmtDate(u.last_active):''}
            ${rev>0?'<br/>üí∞ Revenue: '+inr(rev)+'/mo':''}
            ${expiryHtml}
          </div>
        </div>
        <div style="text-align:right;">
          <span class="badge b-${plan}" style="display:block;margin-bottom:6px;">${plan.toUpperCase()}</span>
          <span style="font-size:11px;font-weight:700;color:${u.is_active!==false?'#4ade80':'#f87171'};">${u.is_active!==false?'‚óè Active':'‚óè Inactive'}</span>
        </div>
      </div>
      <div class="user-actions">
        <select class="plan-sel" onchange="changePlan('${u.id}',this.value)">
          <option value="free" ${plan==='free'?'selected':''}>Free</option>
          <option value="pro" ${plan==='pro'?'selected':''}>Pro ‚Çπ799</option>
          <option value="business" ${plan==='business'?'selected':''}>Business ‚Çπ1999</option>
        </select>
        <button class="act-btn" style="background:#1a2a4a;color:#818cf8;" onclick="extendSub('${u.id}','${plan}')" title="Extend 1 month">+1 Month</button>
        <button class="act-btn ${u.is_active!==false?'act-deact':'act-activ'}" onclick="toggleUser('${u.id}',${u.is_active!==false})">${u.is_active!==false?'üö´ Deact':'‚úÖ Act'}</button>
        <button class="act-btn act-msg" onclick="quickMsg('${u.id}')">üì¢ Msg</button>
      </div>
    </div>`;}).join('');
}
function filterUsers(){renderUsers(document.getElementById('userSearch').value);}
async function changePlan(id,plan){
  const now=new Date();
  const expires=new Date(now);expires.setMonth(expires.getMonth()+1);
  const updates={plan};
  if(plan!=='free'){updates.subscription_started_at=now.toISOString();updates.subscription_expires_at=expires.toISOString();}
  else{updates.subscription_started_at=null;updates.subscription_expires_at=null;}
  await SB.from('profiles').update(updates).eq('id',id);
  AU=AU.map(u=>u.id===id?{...u,...updates}:u);
  renderUsers(document.getElementById('userSearch').value);
  renderRevenue();renderOverview();
  showToast('‚úÖ Plan ‚Üí '+plan.toUpperCase()+(plan!=='free'?' | Expires: '+expires.toLocaleDateString('en-IN'):''));
}
async function extendSub(id,plan){
  if(plan==='free'){showToast('Free plan hai ‚Äî pehle upgrade karein!',false);return;}
  const u=AU.find(x=>x.id===id);
  const base=u?.subscription_expires_at&&new Date(u.subscription_expires_at)>new Date()?new Date(u.subscription_expires_at):new Date();
  const newExp=new Date(base);newExp.setMonth(newExp.getMonth()+1);
  await SB.from('profiles').update({subscription_expires_at:newExp.toISOString()}).eq('id',id);
  AU=AU.map(x=>x.id===id?{...x,subscription_expires_at:newExp.toISOString()}:x);
  renderUsers(document.getElementById('userSearch').value);
  showToast('‚úÖ +1 Month! New expiry: '+newExp.toLocaleDateString('en-IN'));
}
async function toggleUser(id,cur){
  await SB.from('profiles').update({is_active:!cur}).eq('id',id);
  AU=AU.map(u=>u.id===id?{...u,is_active:!cur}:u);
  renderUsers(document.getElementById('userSearch').value);
  showToast(!cur?'‚úÖ User activated!':'üö´ User deactivated!',!cur);
}
function quickMsg(uid){showTab('messages');document.getElementById('msgTarget').value='one';document.getElementById('specificUserDiv').style.display='block';document.getElementById('msgUser').value=uid;}

// ALL QUOTES
function renderAllQuotes(){
  document.getElementById('qtotal').textContent=AQ.length+' quotes';
  if(!AQ.length){document.getElementById('allQuotesList').innerHTML='<div class="empty">No quotes yet</div>';return;}
  const sl={sent:'üì§',followup:'üîî',closed:'‚úÖ',lost:'‚ùå'};
  document.getElementById('allQuotesList').innerHTML=AQ.map(q=>{
    const u=AU.find(x=>x.id===q.user_id);
    return`<div class="q-row">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700;font-size:13px;">${q.customer_name||'‚Äî'}</div>
        <div style="font-size:13px;font-weight:800;color:#ff6b00;">${q.system_kwp} kWp</div>
      </div>
      <div style="font-size:11px;color:#6b7280;margin-top:2px;">${q.quote_number||'‚Äî'} ‚Ä¢ ${q.customer_state} ‚Ä¢ ${fmtDate(q.created_at)}</div>
      <div style="font-size:11px;color:#9ca3af;margin-top:1px;">By: ${u?.company_name||'Unknown'} ${sl[q.status||'sent']} ${q.status||'sent'}</div>
      <div style="display:flex;gap:14px;margin-top:6px;">
        <div><div style="font-size:12px;font-weight:700;">${inr(q.net_cost)}</div><div style="font-size:10px;color:#6b7280;">Cost</div></div>
        <div><div style="font-size:12px;font-weight:700;color:#4ade80;">${inr(q.annual_savings)}/yr</div><div style="font-size:10px;color:#6b7280;">Savings</div></div>
        <div><div style="font-size:11px;font-weight:700;color:#fbbf24;">${q.payback_years}yr PB</div><div style="font-size:10px;color:#6b7280;">Payback</div></div>
      </div>
    </div>`;}).join('');
}

// MESSAGES
function populateUserSel(){
  document.getElementById('msgUser').innerHTML='<option value="">-- Select User --</option>'+AU.map(u=>`<option value="${u.id}">${u.company_name||'User'} (${u.plan||'free'})</option>`).join('');
}
let pendMsg=null;
function previewMsg(){
  const target=document.getElementById('msgTarget').value;
  const uid=document.getElementById('msgUser').value;
  const subj=document.getElementById('msgSubject').value.trim();
  const body=document.getElementById('msgBody').value.trim();
  if(!subj||!body){showToast('Subject & message required!',false);return;}
  let targets=[];
  if(target==='all')targets=AU.map(u=>u.id);
  else if(target==='free')targets=AU.filter(u=>!u.plan||u.plan==='free').map(u=>u.id);
  else if(target==='pro')targets=AU.filter(u=>u.plan==='pro').map(u=>u.id);
  else if(target==='business')targets=AU.filter(u=>u.plan==='business').map(u=>u.id);
  else if(target==='one'){if(!uid){showToast('Select a user!',false);return;}targets=[uid];}
  if(!targets.length){showToast('No users in this group!',false);return;}
  pendMsg={targets,subj,body,target};
  document.getElementById('modalPreview').innerHTML=`<b>TO:</b> ${target==='one'?AU.find(u=>u.id===uid)?.company_name||'User':target.charAt(0).toUpperCase()+target.slice(1)+' ('+targets.length+' users)'}<br/><br/><b>SUBJECT:</b> ${subj}<br/><br/>${body}`;
  document.getElementById('confirmModal').classList.add('show');
}
async function confirmSend(){
  if(!pendMsg)return;
  document.getElementById('confirmModal').classList.remove('show');
  try{
    await SB.from('admin_messages').insert(pendMsg.targets.map(uid=>({user_id:uid,subject:pendMsg.subj,body:pendMsg.body})));
    showToast('‚úÖ Sent to '+pendMsg.targets.length+' user(s)!');
    document.getElementById('msgSubject').value='';document.getElementById('msgBody').value='';
    loadSentMsgs();
  }catch(e){showToast('Error! Check admin_messages table.',false);}
  pendMsg=null;
}
async function loadSentMsgs(){
  try{
    const {data}=await SB.from('admin_messages').select('*, profiles(company_name)').order('created_at',{ascending:false}).limit(20);
    if(!data||!data.length){document.getElementById('sentMsgs').innerHTML='<div class="empty">No messages sent yet</div>';return;}
    document.getElementById('sentMsgs').innerHTML=data.map(m=>`
      <div class="sent-msg">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:700;font-size:13px;">${m.subject}</div>
          <div style="font-size:10px;color:#6b7280;">${fmtDate(m.created_at)}</div>
        </div>
        <div style="font-size:11px;color:#6b7280;margin-top:3px;">To: ${m.profiles?.company_name||'User'}</div>
        <div style="font-size:12px;color:#9ca3af;margin-top:4px;">${m.body.slice(0,100)}${m.body.length>100?'...':''}</div>
      </div>`).join('');
  }catch(e){document.getElementById('sentMsgs').innerHTML='<div class="empty">Run new_tables.sql first</div>';}
}
</script>
</body>
</html>
