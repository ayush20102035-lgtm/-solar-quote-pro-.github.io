<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SolarQuote Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',Arial,sans-serif;background:#f0f4ff;min-height:100vh;}
input,select,textarea,button{font-family:inherit;}
.auth-screen{min-height:100vh;background:linear-gradient(135deg,#0d2060,#1a3370);display:flex;align-items:center;justify-content:center;padding:20px;}
.auth-box{background:white;border-radius:20px;padding:36px 28px;width:100%;max-width:380px;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
.auth-logo{text-align:center;margin-bottom:24px;}
.sun{width:52px;height:52px;background:#ff6b00;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin:0 auto 10px;box-shadow:0 0 20px rgba(255,107,0,0.4);}
.auth-tabs{display:flex;border-radius:10px;overflow:hidden;border:1.5px solid #eee;margin-bottom:20px;}
.auth-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:700;cursor:pointer;background:#fafafa;color:#888;border:none;}
.auth-tab.active{background:#ff6b00;color:white;}
.field{margin-bottom:14px;}
.field label{font-size:12px;color:#666;font-weight:600;display:block;margin-bottom:5px;}
.field input,.field select,.field textarea{width:100%;padding:11px 13px;border-radius:9px;border:1.5px solid #ddd;font-size:14px;outline:none;background:#fafafa;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:#ff6b00;}
.btn-primary{width:100%;padding:13px;border-radius:11px;border:none;background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;font-size:15px;font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(255,107,0,0.3);margin-top:4px;}
.btn-primary:disabled{background:#ccc;box-shadow:none;cursor:not-allowed;}
.msg{padding:10px 14px;border-radius:8px;font-size:13px;font-weight:600;margin-bottom:12px;display:none;}
.msg.ok{background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0;display:block;}
.msg.err{background:#fff5f5;color:#ef4444;border:1px solid #fecaca;display:block;}
.app{display:none;min-height:100vh;background:#f0f4ff;}
nav{background:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,0.07);position:sticky;top:0;z-index:100;}
.nav-logo{display:flex;align-items:center;gap:10px;}
.nav-sun{width:34px;height:34px;background:#ff6b00;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:17px;}
.nav-title{font-weight:800;color:#1a3370;font-size:15px;line-height:1.1;}
.nav-sub{font-size:10px;color:#888;}
.nav-btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:none;}
.nav-btn.outline{background:white;border:1.5px solid #ddd;color:#444;}
.tabs{display:flex;background:white;border-bottom:1px solid #eee;overflow-x:auto;}
.tab{padding:11px 16px;font-size:12px;font-weight:700;color:#888;border:none;background:none;cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;}
.tab.active{color:#ff6b00;border-bottom-color:#ff6b00;}
.card{background:white;border-radius:16px;padding:18px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:14px;}
.sec-title{font-size:10px;font-weight:800;color:#ff6b00;text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.sec-title::after{content:'';flex:1;height:1px;background:#f0f0f0;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.full{grid-column:1/-1;}
.finp label{font-size:11px;color:#888;display:block;margin-bottom:4px;}
.finp input,.finp select,.finp textarea{width:100%;padding:10px 11px;border-radius:8px;border:1.5px solid #ddd;font-size:13px;outline:none;background:#fafafa;}
.finp input:focus,.finp select:focus,.finp textarea:focus{border-color:#ff6b00;background:white;}
.finp textarea{resize:none;}
.finp .err{font-size:11px;color:#f55;margin-top:3px;display:none;}
.finp.has-err input,.finp.has-err select,.finp.has-err textarea{border-color:#f55;background:#fff5f5;}
.finp.has-err .err{display:block;}
.seg{display:flex;border-radius:8px;overflow:hidden;border:1.5px solid #ddd;}
.seg button{flex:1;padding:9px 4px;font-size:11px;font-weight:700;border:none;cursor:pointer;background:#fafafa;color:#888;}
.seg button.active{background:#ff6b00;color:white;}
.metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.metric{background:#f7f8fa;border:1px solid #eee;border-radius:10px;padding:10px 12px;}
.ml{font-size:9px;color:#bbb;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;}
.mv{font-size:16px;font-weight:800;line-height:1;}
.ms{font-size:10px;color:#ccc;margin-top:2px;}
.subsidy-box{background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.roi-bar{background:#f7f8fa;border-radius:10px;padding:10px 12px;margin-bottom:8px;}
.bar-track{height:6px;background:#eee;border-radius:3px;overflow:hidden;margin-top:5px;}
.bar-fill{height:100%;background:linear-gradient(90deg,#ff6b00,#fbbf24);border-radius:3px;transition:width 0.8s;}
.gen-btns{display:flex;gap:10px;margin-top:4px;}
.btn-gen{flex:1;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#ff6b00,#ff9500);color:white;font-size:14px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(255,107,0,0.3);}
.btn-gen:disabled{background:#ccc;box-shadow:none;cursor:not-allowed;}
.btn-wa{padding:14px 16px;border-radius:12px;border:none;background:#25D366;color:white;font-size:18px;cursor:pointer;}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-box{background:white;border-radius:12px;padding:14px 16px;box-shadow:0 2px 10px rgba(0,0,0,0.06);}
.stat-label{font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.stat-val{font-size:20px;font-weight:800;}
.quote-item{padding:14px;border-bottom:1px solid #f0f0f0;}
.quote-item:last-child{border-bottom:none;}
.qi-btns{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.qi-btn{padding:5px 11px;border-radius:7px;border:none;font-size:11px;font-weight:700;cursor:pointer;}
.qi-btn.wa{background:#25D366;color:white;}
.qi-btn.reminder{background:#fff8f0;color:#ff6b00;border:1px solid #ffe4c4;}
.qi-btn.del{background:#fff0f0;color:#ef4444;border:1px solid #fecaca;}
.qi-btn.status{background:#f0f4ff;color:#1a3370;border:1px solid #c7d7ff;}
.plan-badge{padding:2px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.plan-free{background:#fff8f0;color:#ff6b00;}
.plan-pro{background:#f0f4ff;color:#1a3370;}
.plan-business{background:#f0fdf4;color:#16a34a;}
.status-badge{padding:2px 9px;border-radius:20px;font-size:10px;font-weight:700;}
.s-sent{background:#f0f4ff;color:#1a3370;}
.s-followup{background:#fff8f0;color:#ff6b00;}
.s-closed{background:#f0fdf4;color:#16a34a;}
.s-lost{background:#fff5f5;color:#ef4444;}
.page{display:none;padding:16px;}
.page.active{display:block;}
.toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:9999;padding:11px 20px;border-radius:12px;font-weight:700;font-size:13px;color:white;display:none;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,0.2);}
.toast.show{display:block;}
.reminder-item{padding:12px 14px;background:#fff8f0;border-radius:10px;border:1px solid #ffe4c4;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;}
.notif-dot{width:8px;height:8px;background:#ef4444;border-radius:50%;display:inline-block;margin-left:4px;animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal{background:white;border-radius:18px;padding:24px;width:100%;max-width:420px;max-height:90vh;overflow-y:auto;}
.modal h3{font-size:16px;font-weight:800;color:#1a3370;margin-bottom:16px;}
.admin-msg{background:#f0f4ff;border:1px solid #c7d7ff;border-radius:10px;padding:12px 14px;margin-bottom:10px;}
.admin-msg-title{font-size:11px;font-weight:800;color:#1a3370;margin-bottom:4px;}
.admin-msg-body{font-size:13px;color:#444;}
.admin-msg-date{font-size:10px;color:#aaa;margin-top:4px;}
@media(max-width:400px){.grid2{grid-template-columns:1fr;}.gen-btns{flex-direction:column;}}
</style>
</head>
<body>

<!-- AUTH -->
<div class="auth-screen" id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="sun">‚òÄ</div>
      <h2 style="font-size:20px;color:#1a3370;font-weight:800;">SolarQuote Pro</h2>
      <p style="font-size:12px;color:#888;margin-top:2px;" id="authSub">Sign in to continue</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuth('login')">Login</button>
      <button class="auth-tab" onclick="switchAuth('signup')">Sign Up</button>
    </div>
    <div id="authMsg" class="msg"></div>
    <div id="signupExtra" style="display:none;">
      <div class="field"><label>Company Name</label><input id="aCompany" placeholder="ABC Solar Pvt Ltd"/></div>
      <div class="field"><label>Phone</label><input id="aPhone" placeholder="+91-98765-43210"/></div>
    </div>
    <div class="field"><label>Email</label><input type="email" id="aEmail" placeholder="you@example.com"/></div>
    <div class="field"><label>Password</label><input type="password" id="aPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doAuth()"/></div>
    <button class="btn-primary" id="authBtn" onclick="doAuth()">Login</button>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:#aaa;">‚òÅÔ∏è Data syncs across all devices</div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="mainApp">
  <nav>
    <div class="nav-logo">
      <div class="nav-sun">‚òÄ</div>
      <div>
        <div class="nav-title">SolarQuote Pro</div>
        <div class="nav-sub" id="navName">...</div>
      </div>
    </div>
    <div style="display:flex;gap:6px;">
      <button class="nav-btn outline" onclick="showPage('reminders')" style="position:relative;">
        üîî<span id="reminderDot" class="notif-dot" style="display:none;position:absolute;top:4px;right:4px;"></span>
      </button>
      <button class="nav-btn outline" onclick="showPage('settings')">‚öô</button>
      <button class="nav-btn outline" onclick="doLogout()">Exit</button>
    </div>
  </nav>
  <div class="tabs">
    <button class="tab active" onclick="showPage('dashboard')">üìä Dashboard</button>
    <button class="tab" onclick="showPage('quote')">+ Quote</button>
    <button class="tab" onclick="showPage('reminders')">üîî Followups</button>
    <button class="tab" onclick="showPage('template')">üé® Template</button>
    <button class="tab" onclick="showPage('settings')">‚öô</button>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div style="max-width:600px;margin:0 auto;">
      <!-- Admin messages -->
      <div id="adminMsgs"></div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-label">Total Quotes</div><div class="stat-val" id="stTotal" style="color:#ff6b00">-</div></div>
        <div class="stat-box"><div class="stat-label">This Month</div><div class="stat-val" id="stMonth" style="color:#1a3370">-</div></div>
        <div class="stat-box"><div class="stat-label">Total Value</div><div class="stat-val" id="stValue" style="color:#22c55e;font-size:14px">-</div></div>
        <div class="stat-box"><div class="stat-label">Plan</div><div class="stat-val" id="stPlan" style="font-size:13px">-</div></div>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <div style="padding:14px 16px;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;justify-content:space-between;">
          <div style="font-weight:800;color:#1a3370;font-size:14px;">üìã All Quotes</div>
          <button onclick="showPage('quote')" style="font-size:12px;color:#ff6b00;font-weight:700;background:none;border:none;cursor:pointer;">+ New</button>
        </div>
        <div id="quoteList"><div style="text-align:center;padding:30px;color:#aaa;">Loading...</div></div>
      </div>
    </div>
  </div>

  <!-- QUOTE FORM -->
  <div class="page" id="page-quote">
    <div style="max-width:600px;margin:0 auto;">
      <div class="card">
        <div class="sec-title">üë§ Customer Info</div>
        <div class="grid2">
          <div class="finp" id="f-cn"><label>Name *</label><input id="cName" placeholder="Ramesh Kumar"/><div class="err">Required</div></div>
          <div class="finp" id="f-cp"><label>Phone *</label><input id="cPhone" placeholder="+91-98765-43210"/><div class="err">Required</div></div>
          <div class="finp full" id="f-ca"><label>Address *</label><textarea id="cAddr" rows="2" placeholder="Plot 12, Sector 15..."></textarea><div class="err">Required</div></div>
          <div class="finp" id="f-cs"><label>State *</label>
            <select id="cState" onchange="liveCalc()"><option value="">Select...</option>
              <option>Maharashtra</option><option>Gujarat</option><option>Rajasthan</option><option>Tamil Nadu</option><option>Karnataka</option><option>Delhi</option><option>Uttar Pradesh</option><option>Telangana</option><option>Haryana</option><option>Punjab</option><option>Madhya Pradesh</option><option>Andhra Pradesh</option><option>West Bengal</option><option>Bihar</option><option>Odisha</option><option>Other</option>
            </select><div class="err">Required</div>
          </div>
          <div class="finp"><label>DISCOM</label><input id="cDiscom" placeholder="MSEDCL, BSES..."/></div>
        </div>
      </div>
      <div class="card">
        <div class="sec-title">‚ö° System Details</div>
        <div class="grid2">
          <div class="finp" id="f-bill"><label>Monthly Bill (‚Çπ) *</label><input type="number" id="fBill" placeholder="5000" oninput="liveCalc()"/><div class="err">Enter amount</div></div>
          <div class="finp"><label>Tariff ‚Çπ/kWh</label><input type="number" id="fTariff" value="7" step="0.5" oninput="liveCalc()"/></div>
          <div class="finp"><label>Roof Area (sqft)</label><input type="number" id="fRoof" placeholder="Optional" oninput="liveCalc()"/></div>
          <div class="finp"><label>Phase</label><select id="fPhase"><option value="single">Single Phase</option><option value="three">Three Phase</option></select></div>
          <div class="finp full"><label>Category</label>
            <div class="seg">
              <button class="active" onclick="setCat('residential',this)">üè† Residential</button>
              <button onclick="setCat('commercial',this)">üè¢ Commercial</button>
              <button onclick="setCat('industrial',this)">üè≠ Industrial</button>
            </div>
          </div>
          <div class="finp"><label>Panel</label><select id="fPanel"><option>Tier-1 Mono PERC/TOPCon</option><option>Waaree</option><option>Adani Solar</option><option>Tata Power Solar</option><option>Vikram Solar</option><option>Longi</option><option>Jinko</option></select></div>
          <div class="finp"><label>Inverter</label><select id="fInverter"><option>Best Available</option><option>Sungrow</option><option>SolarEdge</option><option>Fronius</option><option>Growatt</option><option>Delta</option><option>Huawei</option></select></div>
          <div class="finp"><label>Custom Rate ‚Çπ/kWp</label><input type="number" id="fRate" placeholder="Blank=standard" oninput="liveCalc()"/></div>
          <div class="finp"><label>Discount (‚Çπ)</label><input type="number" id="fDisc" value="0" oninput="liveCalc()"/></div>
        </div>
      </div>
      <div class="card">
        <div class="sec-title">üìä Live Estimate</div>
        <div id="livePanel"><div style="text-align:center;padding:20px;color:#ccc;"><div style="font-size:32px;">‚òÄ</div><div style="font-size:12px;margin-top:6px;">Enter monthly bill</div></div></div>
      </div>
      <div class="gen-btns">
        <button class="btn-gen" id="genBtn" onclick="generateQuote()">‚òÄ Generate & Download PDF</button>
        <button class="btn-wa" onclick="sendWA()">üì±</button>
      </div>
      <div style="text-align:center;font-size:11px;color:#bbb;margin-top:6px;">PDF downloads + saved to cloud ‚òÅÔ∏è</div>
    </div>
  </div>

  <!-- REMINDERS / FOLLOWUPS -->
  <div class="page" id="page-reminders">
    <div style="max-width:600px;margin:0 auto;">
      <div class="card">
        <div class="sec-title">üîî Follow-up Reminders</div>
        <div id="reminderList"><div style="text-align:center;padding:20px;color:#aaa;">Loading...</div></div>
      </div>
      <div class="card" style="background:#fff8f0;border:1.5px solid #ffe4c4;">
        <div style="font-size:12px;color:#888;line-height:1.8;">
          <b style="color:#ff6b00;">üí° Follow-up Tips:</b><br/>
          ‚Ä¢ Day 1: Quote bheja ‚Äî confirm karo<br/>
          ‚Ä¢ Day 3: Follow-up call karo<br/>
          ‚Ä¢ Day 7: Site visit fix karo<br/>
          ‚Ä¢ Day 14: Final decision lo
        </div>
      </div>
    </div>
  </div>

  <!-- TEMPLATE CUSTOMIZE -->
  <div class="page" id="page-template">
    <div style="max-width:600px;margin:0 auto;">
      <div class="card">
        <div class="sec-title">üé® PDF Template Customize</div>
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div class="finp"><label>Quote Header Title</label><input id="tTitle" placeholder="Professional Solar Quotation | India 2025"/></div>
          <div class="finp"><label>Footer / Tagline</label><input id="tFooter" placeholder="India ka #1 Solar Installer"/></div>
          <div class="finp"><label>WhatsApp Message Template</label><textarea id="tWA" rows="5" placeholder="Customized WhatsApp message..."></textarea></div>
          <div class="finp"><label>Terms & Conditions (PDF)</label><textarea id="tTerms" rows="3" placeholder="Custom terms..."></textarea></div>
          <div class="finp"><label>Header Color</label>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <div onclick="setColor('#1a3370')" style="width:36px;height:36px;background:#1a3370;border-radius:8px;cursor:pointer;border:3px solid transparent;" id="clr-navy" class="clr-opt active-clr"></div>
              <div onclick="setColor('#0d6b2e')" style="width:36px;height:36px;background:#0d6b2e;border-radius:8px;cursor:pointer;border:3px solid transparent;" id="clr-green" class="clr-opt"></div>
              <div onclick="setColor('#7c1a1a')" style="width:36px;height:36px;background:#7c1a1a;border-radius:8px;cursor:pointer;border:3px solid transparent;" id="clr-red" class="clr-opt"></div>
              <div onclick="setColor('#1a1a7c')" style="width:36px;height:36px;background:#1a1a7c;border-radius:8px;cursor:pointer;border:3px solid transparent;" id="clr-blue" class="clr-opt"></div>
              <div onclick="setColor('#4a1a7c')" style="width:36px;height:36px;background:#4a1a7c;border-radius:8px;cursor:pointer;border:3px solid transparent;" id="clr-purple" class="clr-opt"></div>
              <div onclick="setColor('#7c4a1a')" style="width:36px;height:36px;background:#7c4a1a;border-radius:8px;cursor:pointer;border:3px solid transparent;" id="clr-brown" class="clr-opt"></div>
            </div>
          </div>
          <div class="finp"><label>Payment Terms Custom</label><textarea id="tPayment" rows="2" placeholder="30% Advance | 60% Before Install | 10% After..."></textarea></div>
          <button class="btn-primary" onclick="saveTemplate()">üíæ Save Template</button>
        </div>
      </div>
      <div class="card" style="background:#f0f4ff;">
        <div style="font-size:12px;color:#666;line-height:1.8;">
          <b style="color:#1a3370;">üí° Template Tips:</b><br/>
          ‚Ä¢ Header title PDF ke top pe dikhega<br/>
          ‚Ä¢ WA template quote ke saath bhejega<br/>
          ‚Ä¢ Color change se PDF alag dikhega<br/>
          ‚Ä¢ Terms PDF ke bottom mein jayenge
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="page" id="page-settings">
    <div style="max-width:500px;margin:0 auto;">
      <div class="card">
        <div class="sec-title">‚öô Company Branding</div>
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div class="finp"><label>Company Name</label><input id="sCompany" placeholder="ABC Solar Pvt Ltd"/></div>
          <div class="finp"><label>Phone</label><input id="sPhone" placeholder="+91-99999-00000"/></div>
          <div class="finp"><label>GST Number</label><input id="sGst" placeholder="27XXXXX1234X1ZX"/></div>
          <div class="finp"><label>Website</label><input id="sWeb" placeholder="www.abcsolar.in"/></div>
          <button class="btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
        </div>
      </div>
      <div class="card">
        <div class="sec-title">üë§ Account</div>
        <div style="font-size:13px;color:#666;line-height:2.2;">
          <div>Email: <b id="settEmail">-</b></div>
          <div>Plan: <span id="settPlan" class="plan-badge plan-free">Free</span></div>
        </div>
        <button onclick="doLogout()" style="margin-top:14px;width:100%;padding:11px;border-radius:9px;border:1.5px solid #ddd;background:white;color:#666;font-weight:700;cursor:pointer;font-size:13px;">Logout</button>
      </div>
    </div>
  </div>
</div>

<!-- REMINDER MODAL -->
<div class="modal-overlay" id="reminderModal">
  <div class="modal">
    <h3>üîî Set Follow-up Reminder</h3>
    <div class="field"><label>Customer Name</label><input id="rName" readonly style="background:#f0f0f0;"/></div>
    <div class="field"><label>Reminder Date</label><input type="date" id="rDate"/></div>
    <div class="field"><label>Note</label><textarea id="rNote" rows="2" placeholder="Call regarding quotation..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button onclick="saveReminder()" style="flex:1;padding:12px;border-radius:10px;border:none;background:#ff6b00;color:white;font-weight:800;cursor:pointer;">Save Reminder</button>
      <button onclick="closeModal('reminderModal')" style="padding:12px 18px;border-radius:10px;border:1.5px solid #ddd;background:white;font-weight:700;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<!-- STATUS MODAL -->
<div class="modal-overlay" id="statusModal">
  <div class="modal">
    <h3>üìä Update Quote Status</h3>
    <input type="hidden" id="statusQuoteId"/>
    <div class="field"><label>Status</label>
      <select id="statusSelect">
        <option value="sent">üì§ Sent</option>
        <option value="followup">üîî Follow-up Pending</option>
        <option value="closed">‚úÖ Closed (Won)</option>
        <option value="lost">‚ùå Lost</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button onclick="saveStatus()" style="flex:1;padding:12px;border-radius:10px;border:none;background:#1a3370;color:white;font-weight:800;cursor:pointer;">Update Status</button>
      <button onclick="closeModal('statusModal')" style="padding:12px 18px;border-radius:10px;border:1.5px solid #ddd;background:white;font-weight:700;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SB=supabase.createClient('https://sveixtxuascbvoeyxqgl.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2ZWl4dHh1YXNjYnZvZXl4cWdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTI3MDQsImV4cCI6MjA4Nzc2ODcwNH0.t6Bs8weRt4EMjiX0aICArsGaVS6buiakrPST4RVsfHY');
const SC={panelWatt:545,res:45000,com:40000,ind:35000,s2:30000,s3:60000,s3p:78000,upd:4.5,deg:0.005,exp:3.5,maint:0.01,co2:0.82};
const NM={Maharashtra:"Net Metering up to 1 MW | MSEDCL | Annual",Gujarat:"Net Metering up to 1 MW | DGVCL | Monthly",Rajasthan:"Net Metering up to 1 MW | JDVVNL | Quarterly","Tamil Nadu":"Net Metering up to 1 MW | TANGEDCO | Annual",Karnataka:"Net Metering up to 1 MW | BESCOM | Annual",Delhi:"Net Metering up to 500 kW | BSES | Monthly","Uttar Pradesh":"Net Metering up to 1 MW | UPPCL | Quarterly",Telangana:"Net Metering up to 1 MW | TSSPDCL | Annual",Haryana:"Net Metering up to 500 kW | DHBVN | Monthly",Punjab:"Net Metering up to 1 MW | PSPCL | Annual",Other:"Net Metering as per MNRE/CERC guidelines."};
let cat='residential',currentUser=null,currentProfile=null,currentTemplate={color:'#1a3370',title:'',footer:'',wa:'',terms:'',payment:''},pendingReminderId=null,pendingReminderName=null;

function inr(n){const a=Math.abs(Math.round(n));const s=a.toString();if(s.length<=3)return(n<0?'-':'')+'‚Çπ'+s;let r=s.slice(-3),m=s.slice(0,-3);while(m.length>2){r=m.slice(-2)+','+r;m=m.slice(0,-2);}return(n<0?'-':'')+'‚Çπ'+m+','+r;}
function showToast(msg,ok=true){const t=document.getElementById('toast');t.textContent=msg;t.style.background=ok?'#22c55e':'#ef4444';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3500);}
function closeModal(id){document.getElementById(id).classList.remove('show');}

// AUTH
let authMode='login';
function switchAuth(m){
  authMode=m;
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(m==='login'&&i===0)||(m==='signup'&&i===1)));
  document.getElementById('signupExtra').style.display=m==='signup'?'block':'none';
  document.getElementById('authBtn').textContent=m==='login'?'Login':'Create Free Account';
  document.getElementById('authSub').textContent=m==='login'?'Sign in to continue':'Create your free account';
  document.getElementById('authMsg').className='msg';
}
async function doAuth(){
  const email=document.getElementById('aEmail').value.trim();
  const pass=document.getElementById('aPass').value;
  const msg=document.getElementById('authMsg');
  if(!email||!pass){msg.className='msg err';msg.textContent='Fill all fields';return;}
  document.getElementById('authBtn').disabled=true;document.getElementById('authBtn').textContent='Please wait...';
  if(authMode==='signup'){
    const {data,error}=await SB.auth.signUp({email,password:pass});
    if(error){msg.className='msg err';msg.textContent=error.message;document.getElementById('authBtn').disabled=false;document.getElementById('authBtn').textContent='Create Free Account';return;}
    if(data.user){await SB.from('profiles').upsert({id:data.user.id,company_name:document.getElementById('aCompany').value||'My Solar Company',phone:document.getElementById('aPhone').value||''});}
    msg.className='msg ok';msg.textContent='‚úÖ Account created!';
    setTimeout(()=>loadApp(data.user),1000);
  } else {
    const {data,error}=await SB.auth.signInWithPassword({email,password:pass});
    if(error){msg.className='msg err';msg.textContent=error.message;document.getElementById('authBtn').disabled=false;document.getElementById('authBtn').textContent='Login';return;}
    loadApp(data.user);
  }
}
async function loadApp(user){
  currentUser=user;
  const {data:prof}=await SB.from('profiles').select('*').eq('id',user.id).single();
  currentProfile=prof;
  document.getElementById('authScreen').style.display='none';
  document.getElementById('mainApp').style.display='block';
  document.getElementById('navName').textContent=prof?.company_name||user.email;
  document.getElementById('settEmail').textContent=user.email;
  document.getElementById('sCompany').value=prof?.company_name||'';
  document.getElementById('sPhone').value=prof?.phone||'';
  document.getElementById('sGst').value=prof?.gst||'';
  document.getElementById('sWeb').value=prof?.website||'';
  const plan=prof?.plan||'free';
  document.getElementById('settPlan').textContent=plan.charAt(0).toUpperCase()+plan.slice(1);
  document.getElementById('settPlan').className='plan-badge plan-'+plan;
  loadTemplate();
  loadAdminMessages();
  loadDashboard();
  checkReminders();
}
async function doLogout(){await SB.auth.signOut();document.getElementById('mainApp').style.display='none';document.getElementById('authScreen').style.display='flex';}
window.onload=async function(){const {data}=await SB.auth.getSession();if(data.session)loadApp(data.session.user);};

// NAVIGATION
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const idx={dashboard:0,quote:1,reminders:2,template:3,settings:4}[name];
  if(idx!==undefined)document.querySelectorAll('.tab')[idx].classList.add('active');
  if(name==='dashboard')loadDashboard();
  if(name==='reminders')loadReminders();
  window.scrollTo(0,0);
}

// SOLAR CALC
function setCat(c,btn){cat=c;document.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');liveCalc();}
function calcD(){
  const bill=parseFloat(document.getElementById('fBill').value)||0;
  const tariff=parseFloat(document.getElementById('fTariff').value)||7;
  const roof=parseFloat(document.getElementById('fRoof').value)||null;
  const cr=parseFloat(document.getElementById('fRate').value)||null;
  const disc=parseFloat(document.getElementById('fDisc').value)||0;
  if(!bill||bill<100)return null;
  let kWp=Math.round((bill/tariff/30/SC.upd)*2)/2;kWp=Math.max(1,kWp);
  if(roof){const mx=Math.round(((roof*0.0929)/10)*2)/2;if(kWp>mx)kWp=Math.max(1,mx);}
  const panels=Math.ceil((kWp*1000)/SC.panelWatt);
  const cpp=cr||(cat==='residential'?SC.res:cat==='commercial'?SC.com:SC.ind);
  const gross=kWp*cpp;
  let sub=0;if(cat==='residential'&&kWp<=10){if(kWp<=2)sub=SC.s2;else if(kWp<=3)sub=SC.s3;else sub=SC.s3p;}
  const net=gross-sub-disc,gen=kWp*SC.upd*365,self=gen*0.7,expU=gen*0.3;
  const sav=self*tariff+expU*SC.exp,maint=gross*SC.maint,netSav=sav-maint,pb=net/netSav;
  let life=0;for(let y=1;y<=25;y++){const dg=gen*Math.pow(1-SC.deg,y);life+=dg*0.7*tariff+dg*0.3*SC.exp-maint;}
  const roi=((life-net)/net)*100,co2=(gen*SC.co2)/1000;
  return{kWp,panels,gross:Math.round(gross),sub:Math.round(sub),disc:Math.round(disc),net:Math.round(net),gen:Math.round(gen),self:Math.round(self),expU:Math.round(expU),sav:Math.round(sav),maint:Math.round(maint),netSav:Math.round(netSav),pb:+pb.toFixed(1),life:Math.round(life),roi:+roi.toFixed(1),co2:+co2.toFixed(2),tariff,cat};
}
function liveCalc(){
  const d=calcD();const p=document.getElementById('livePanel');
  if(!d){p.innerHTML='<div style="text-align:center;padding:16px;color:#ccc;"><div style="font-size:32px;">‚òÄ</div><div style="font-size:12px;margin-top:6px;">Enter monthly bill</div></div>';return;}
  let sub=d.sub>0?`<div class="subsidy-box"><span style="font-size:20px">üèõ</span><div><div style="font-size:9px;font-weight:800;color:#16a34a;letter-spacing:1px">MNRE SUBSIDY!</div><div style="font-size:17px;font-weight:800;color:#16a34a">${inr(d.sub)}</div></div></div>`:'';
  p.innerHTML=`<div class="metric-grid"><div class="metric"><div class="ml">System</div><div class="mv" style="color:#f60">${d.kWp} kWp</div><div class="ms">${d.panels} panels</div></div><div class="metric"><div class="ml">Annual Gen</div><div class="mv" style="color:#f59e0b">${d.gen.toLocaleString()}</div><div class="ms">kWh/yr</div></div><div class="metric"><div class="ml">Net Cost</div><div class="mv" style="color:#f60">${inr(d.net)}</div><div class="ms">${inr(d.gross)} gross</div></div><div class="metric"><div class="ml">Savings/yr</div><div class="mv" style="color:#22c55e">${inr(d.netSav)}</div><div class="ms">${d.pb}yr payback</div></div></div>${sub}<div class="roi-bar"><div style="display:flex;justify-content:space-between;font-size:10px;color:#bbb"><span>25-Year ROI</span><span style="font-weight:800;color:#f59e0b">${d.roi}%</span></div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100,d.roi/5)}%"></div></div></div><div style="text-align:center;font-size:10px;color:#bbb">üå± ${d.co2}t CO‚ÇÇ/yr = ${Math.round(d.co2*45)} trees</div>`;
}

// DASHBOARD
async function loadDashboard(){
  if(!currentUser)return;
  const {data:quotes}=await SB.from('quotes').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
  const qs=quotes||[];
  const now=new Date();
  document.getElementById('stTotal').textContent=qs.length;
  document.getElementById('stMonth').textContent=qs.filter(q=>new Date(q.created_at).getMonth()===now.getMonth()).length;
  document.getElementById('stValue').textContent=inr(qs.reduce((a,q)=>a+(q.net_cost||0),0));
  const plan=currentProfile?.plan||'free';
  document.getElementById('stPlan').innerHTML=`<span class="plan-badge plan-${plan}">${plan.charAt(0).toUpperCase()+plan.slice(1)}</span>`;
  if(qs.length===0){document.getElementById('quoteList').innerHTML='<div style="text-align:center;padding:40px;color:#ccc;"><div style="font-size:40px;">‚òÄ</div><div style="font-weight:700;font-size:14px;margin:8px 0 4px;">No quotes yet</div><button onclick="showPage(\'quote\')" style="margin-top:10px;padding:10px 24px;border-radius:9px;background:#ff6b00;color:white;border:none;font-weight:700;cursor:pointer;">+ New Quote</button></div>';return;}
  const statusLabels={sent:'üì§ Sent',followup:'üîî Follow-up',closed:'‚úÖ Closed',lost:'‚ùå Lost'};
  document.getElementById('quoteList').innerHTML=qs.map(q=>`
    <div class="quote-item">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="font-weight:700;font-size:14px;">${q.customer_name}</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="status-badge s-${q.status||'sent'}">${statusLabels[q.status||'sent']}</span>
          <span style="font-size:13px;font-weight:800;color:#ff6b00;">${q.system_kwp} kWp</span>
        </div>
      </div>
      <div style="font-size:11px;color:#aaa;margin-top:2px;">${q.quote_number} ‚Ä¢ ${q.customer_state} ‚Ä¢ ${new Date(q.created_at).toLocaleDateString('en-IN')}</div>
      <div style="display:flex;gap:14px;margin-top:6px;">
        <div><div style="font-size:13px;font-weight:700;">${inr(q.net_cost)}</div><div style="font-size:10px;color:#aaa;">Cost</div></div>
        <div><div style="font-size:13px;font-weight:700;color:#22c55e;">${inr(q.annual_savings)}/yr</div><div style="font-size:10px;color:#aaa;">Savings</div></div>
        <div><div style="font-size:12px;font-weight:700;color:#f59e0b;">${q.payback_years} yrs</div><div style="font-size:10px;color:#aaa;">Payback</div></div>
      </div>
      <div class="qi-btns">
        <button class="qi-btn wa" onclick="waDash('${q.customer_name}',${q.system_kwp},${q.net_cost},${q.annual_savings},${q.payback_years})">üì± WA</button>
        <button class="qi-btn reminder" onclick="openReminder('${q.id}','${q.customer_name}')">üîî Remind</button>
        <button class="qi-btn status" onclick="openStatus('${q.id}','${q.status||'sent'}')">üìä Status</button>
        <button class="qi-btn del" onclick="delQuote('${q.id}')">üóë</button>
      </div>
    </div>`).join('');
}

async function delQuote(id){if(!confirm('Delete?'))return;await SB.from('quotes').delete().eq('id',id);showToast('Deleted!');loadDashboard();}

function waDash(name,kwp,net,sav,pb){
  const company=currentProfile?.company_name||'SolarQuote Pro';
  const tmpl=currentTemplate.wa||`Hi ${name},%0A%0AYour Solar Quote:%0A‚òÄ *${kwp} kWp* System%0Aüí∞ Investment: *${inr(net)}*%0Aüìä Savings: *${inr(sav)}/yr*%0A‚è± Payback: *${pb} Yrs*%0A%0AFrom: ${company}`;
  window.open('https://wa.me/?text='+tmpl.replace('{name}',name).replace('{kwp}',kwp).replace('{net}',inr(net)).replace('{sav}',inr(sav)).replace('{pb}',pb).replace('{company}',company),'_blank');
}

// REMINDERS
function openReminder(id,name){
  pendingReminderId=id;pendingReminderName=name;
  document.getElementById('rName').value=name;
  const d=new Date();d.setDate(d.getDate()+3);
  document.getElementById('rDate').value=d.toISOString().split('T')[0];
  document.getElementById('rNote').value='Follow-up call regarding solar quotation';
  document.getElementById('reminderModal').classList.add('show');
}
function saveReminder(){
  const reminders=JSON.parse(localStorage.getItem('sq_reminders')||'[]');
  reminders.push({id:Date.now().toString(),quoteId:pendingReminderId,name:pendingReminderName,date:document.getElementById('rDate').value,note:document.getElementById('rNote').value,done:false,userId:currentUser?.id});
  localStorage.setItem('sq_reminders',JSON.stringify(reminders));
  closeModal('reminderModal');
  showToast('‚úÖ Reminder set!');
  checkReminders();
}
function loadReminders(){
  const reminders=JSON.parse(localStorage.getItem('sq_reminders')||'[]').filter(r=>r.userId===currentUser?.id);
  const today=new Date().toISOString().split('T')[0];
  if(reminders.length===0){document.getElementById('reminderList').innerHTML='<div style="text-align:center;padding:30px;color:#ccc;"><div style="font-size:36px;">üîî</div><div style="font-size:13px;margin-top:8px;">No reminders set</div><div style="font-size:11px;margin-top:4px;color:#ddd;">Set reminders from Dashboard ‚Üí Quote ‚Üí üîî Remind</div></div>';return;}
  document.getElementById('reminderList').innerHTML=reminders.sort((a,b)=>a.date.localeCompare(b.date)).map(r=>`
    <div class="reminder-item" style="${r.done?'opacity:0.5;':''}${r.date<=today&&!r.done?'background:#fff0f0;border-color:#fecaca;':''}">
      <div>
        <div style="font-weight:700;font-size:13px;">${r.name}</div>
        <div style="font-size:12px;color:#888;margin-top:2px;">üìÖ ${new Date(r.date).toLocaleDateString('en-IN')}</div>
        <div style="font-size:11px;color:#aaa;margin-top:2px;">${r.note}</div>
        ${r.date<=today&&!r.done?'<div style="font-size:11px;color:#ef4444;font-weight:700;margin-top:3px;">‚ö† Due today!</div>':''}
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        ${!r.done?`<button onclick="doneReminder('${r.id}')" style="padding:5px 10px;border-radius:7px;background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0;font-size:11px;font-weight:700;cursor:pointer;">‚úÖ Done</button>`:'<span style="font-size:11px;color:#16a34a;font-weight:700;">‚úÖ Done</span>'}
        <button onclick="delReminder('${r.id}')" style="padding:5px 10px;border-radius:7px;background:#fff0f0;color:#ef4444;border:1px solid #fecaca;font-size:11px;font-weight:700;cursor:pointer;">üóë</button>
      </div>
    </div>`).join('');
}
function doneReminder(id){
  const reminders=JSON.parse(localStorage.getItem('sq_reminders')||'[]');
  const updated=reminders.map(r=>r.id===id?{...r,done:true}:r);
  localStorage.setItem('sq_reminders',JSON.stringify(updated));
  loadReminders();checkReminders();showToast('‚úÖ Marked as done!');
}
function delReminder(id){
  const reminders=JSON.parse(localStorage.getItem('sq_reminders')||'[]').filter(r=>r.id!==id);
  localStorage.setItem('sq_reminders',JSON.stringify(reminders));
  loadReminders();checkReminders();
}
function checkReminders(){
  const reminders=JSON.parse(localStorage.getItem('sq_reminders')||'[]').filter(r=>r.userId===currentUser?.id);
  const today=new Date().toISOString().split('T')[0];
  const due=reminders.filter(r=>!r.done&&r.date<=today).length;
  document.getElementById('reminderDot').style.display=due>0?'inline-block':'none';
}

// STATUS
function openStatus(id,status){
  document.getElementById('statusQuoteId').value=id;
  document.getElementById('statusSelect').value=status;
  document.getElementById('statusModal').classList.add('show');
}
async function saveStatus(){
  const id=document.getElementById('statusQuoteId').value;
  const status=document.getElementById('statusSelect').value;
  await SB.from('quotes').update({status}).eq('id',id);
  closeModal('statusModal');
  showToast('‚úÖ Status updated!');
  loadDashboard();
}

// ADMIN MESSAGES
async function loadAdminMessages(){
  try{
    const {data:msgs}=await SB.from('admin_messages').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false}).limit(3);
    if(!msgs||msgs.length===0){document.getElementById('adminMsgs').innerHTML='';return;}
    document.getElementById('adminMsgs').innerHTML=`<div class="card" style="background:#f0f4ff;border:1.5px solid #c7d7ff;margin-bottom:14px;">
      <div style="font-size:10px;font-weight:800;color:#1a3370;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">üì¢ Message from Admin</div>
      ${msgs.map(m=>`<div class="admin-msg"><div class="admin-msg-title">${m.subject||'Message'}</div><div class="admin-msg-body">${m.body}</div><div class="admin-msg-date">${new Date(m.created_at).toLocaleDateString('en-IN')}</div></div>`).join('')}
    </div>`;
  }catch(e){document.getElementById('adminMsgs').innerHTML='';}
}

// TEMPLATE
function setColor(color){
  currentTemplate.color=color;
  document.querySelectorAll('.clr-opt').forEach(c=>c.style.border='3px solid transparent');
  event.target.style.border='3px solid #ff6b00';
  localStorage.setItem('sq_template_'+currentUser?.id,JSON.stringify(currentTemplate));
}
function loadTemplate(){
  const saved=localStorage.getItem('sq_template_'+currentUser?.id);
  if(saved){currentTemplate=JSON.parse(saved);}
  document.getElementById('tTitle').value=currentTemplate.title||'';
  document.getElementById('tFooter').value=currentTemplate.footer||'';
  document.getElementById('tWA').value=currentTemplate.wa||'';
  document.getElementById('tTerms').value=currentTemplate.terms||'';
  document.getElementById('tPayment').value=currentTemplate.payment||'';
}
function saveTemplate(){
  currentTemplate.title=document.getElementById('tTitle').value;
  currentTemplate.footer=document.getElementById('tFooter').value;
  currentTemplate.wa=document.getElementById('tWA').value;
  currentTemplate.terms=document.getElementById('tTerms').value;
  currentTemplate.payment=document.getElementById('tPayment').value;
  localStorage.setItem('sq_template_'+currentUser?.id,JSON.stringify(currentTemplate));
  showToast('‚úÖ Template saved!');
}

// GENERATE
function validate(){
  let ok=true;
  [['cName','f-cn'],['cPhone','f-cp'],['cAddr','f-ca'],['cState','f-cs'],['fBill','f-bill']].forEach(([id,fid])=>{
    const v=document.getElementById(id).value.trim();
    const fe=document.getElementById(fid);
    if(!v){fe.classList.add('has-err');ok=false;}else fe.classList.remove('has-err');
  });
  return ok;
}
async function generateQuote(){
  if(!validate()){showToast('Fill required fields!',false);return;}
  const d=calcD();if(!d){showToast('Enter bill!',false);return;}
  if(!window.jspdf){showToast('PDF loading...',false);return;}
  const btn=document.getElementById('genBtn');btn.disabled=true;btn.textContent='‚è≥ Generating...';
  try{
    const now=new Date();
    const qno='SQ-'+now.getFullYear()+String(now.getMonth()+1).padStart(2,'0')+String(now.getDate()).padStart(2,'0')+'-'+String(now.getHours()).padStart(2,'0')+String(now.getMinutes()).padStart(2,'0');
    buildPDF(d,qno);
    await SB.from('quotes').insert({user_id:currentUser.id,quote_number:qno,customer_name:document.getElementById('cName').value,customer_phone:document.getElementById('cPhone').value,customer_state:document.getElementById('cState').value,system_kwp:d.kWp,net_cost:d.net,annual_savings:d.netSav,payback_years:d.pb,status:'sent'});
    showToast('‚úÖ PDF Downloaded & Saved!');
  }catch(e){showToast('Error: '+e.message,false);}
  btn.disabled=false;btn.textContent='‚òÄ Generate & Download PDF';
}
function sendWA(){
  const d=calcD();const name=document.getElementById('cName').value;const phone=document.getElementById('cPhone').value;
  if(!d||!name){showToast('Fill form first!',false);return;}
  const company=currentProfile?.company_name||'SolarQuote Pro';
  let msg=currentTemplate.wa||`Hi ${name},%0A%0AYour Solar Quote:%0A‚òÄ *${d.kWp} kWp* System%0Aüí∞ Investment: *${inr(d.net)}*%0Aüèõ Subsidy: *${inr(d.sub)}*%0Aüìä Savings: *${inr(d.netSav)}/yr*%0A‚è± Payback: *${d.pb} Yrs*%0Aüìà ROI: *${d.roi}%25*%0A%0AFrom: ${company}`;
  msg=msg.replace('{name}',name).replace('{kwp}',d.kWp).replace('{net}',inr(d.net)).replace('{sav}',inr(d.netSav)).replace('{pb}',d.pb).replace('{company}',company);
  const ph=phone.replace(/\D/g,'');
  window.open('https://wa.me/'+(ph.startsWith('91')?ph:'91'+ph)+'?text='+encodeURIComponent(msg),'_blank');
}

// SETTINGS
async function saveSettings(){
  const company=document.getElementById('sCompany').value.trim();
  const phone=document.getElementById('sPhone').value.trim();
  const gst=document.getElementById('sGst').value.trim();
  const website=document.getElementById('sWeb').value.trim();
  await SB.from('profiles').upsert({id:currentUser.id,company_name:company,phone,gst,website});
  currentProfile={...currentProfile,company_name:company,phone,gst,website};
  document.getElementById('navName').textContent=company||currentUser.email;
  showToast('‚úÖ Settings saved!');
}

// PDF
function buildPDF(d,qno){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
  const now=new Date();
  const dateStr=now.toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const validTill=new Date(now.getTime()+30*864e5).toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const name=document.getElementById('cName').value;
  const phone=document.getElementById('cPhone').value;
  const addr=document.getElementById('cAddr').value;
  const state=document.getElementById('cState').value;
  const discom=document.getElementById('cDiscom').value||'Local DISCOM';
  const company=currentProfile?.company_name||'SolarQuote Pro';
  const iph=currentProfile?.phone||'';
  const gst=currentProfile?.gst||'';
  const panel=document.getElementById('fPanel').value;
  const inv=document.getElementById('fInverter').value;
  const phase=document.getElementById('fPhase').value;
  const nm=NM[state]||NM['Other'];
  const hdrColor=currentTemplate.color||'#1a3370';
  const hc=[parseInt(hdrColor.slice(1,3),16),parseInt(hdrColor.slice(3,5),16),parseInt(hdrColor.slice(5,7),16)];
  const title=currentTemplate.title||'Professional Solar Quotation | India 2025';
  const terms=currentTemplate.terms||'Generation may vary +/-10%. Subsidy subject to policy. Net metering subject to DISCOM. Quote valid 30 days.';
  const payment=currentTemplate.payment||'30% Advance | 60% Before Installation | 10% After Commissioning';
  const W=210,M=12;let y=0;
  const R=(x,fy,w,h,r,g,b)=>{doc.setFillColor(r,g,b);doc.rect(x,fy,w,h,'F');};
  const T=(t,x,fy,o={})=>{doc.setFont('helvetica',o.b?'bold':'normal');doc.setFontSize(o.s||9);doc.setTextColor(...(o.c||[30,30,30]));doc.text(String(t),x,fy,{align:o.a||'left'});};
  const L=(x1,y1,x2,y2,r=200,g=200,b=200,w=0.2)=>{doc.setDrawColor(r,g,b);doc.setLineWidth(w);doc.line(x1,y1,x2,y2);};
  R(0,0,W,28,...hc);doc.setFillColor(255,107,0);doc.circle(M+5,14,5,'F');doc.setFillColor(255,200,80);doc.circle(M+5,14,2.5,'F');
  T('SolarQuote Pro',M+13,11,{b:true,s:16,c:[255,255,255]});T(title,M+13,18,{s:7.5,c:[200,220,255]});
  T('Quote: '+qno,W-M,10,{s:8,c:[200,220,255],a:'right'});T('Date: '+dateStr,W-M,16,{s:8,c:[200,220,255],a:'right'});T('Valid: '+validTill,W-M,22,{s:8,c:[200,220,255],a:'right'});y=32;
  R(M,y,W-2*M,8,255,107,0);T('Prepared by: '+company+(iph?' | '+iph:'')+(gst?' | GST: '+gst:''),M+3,y+5.5,{b:true,s:7.5,c:[255,255,255]});y+=11;
  R(M,y,W-2*M,7,...hc);T('CUSTOMER DETAILS',M+3,y+5,{b:true,s:8,c:[255,255,255]});y+=7;
  [[name,phone,'Customer Name','Phone'],[addr,state,'Address','State'],[discom,d.cat.charAt(0).toUpperCase()+d.cat.slice(1),'DISCOM','Category']].forEach(([v1,v2,l1,l2],i)=>{
    R(M,y,W-2*M,8,i%2===0?245:255,i%2===0?246:255,i%2===0?248:255);L(M,y+8,W-M,y+8);
    T(l1+':',M+3,y+5.5,{s:8,c:[130,130,130]});T(v1,M+38,y+5.5,{b:true,s:8.5});T(l2+':',M+108,y+5.5,{s:8,c:[130,130,130]});T(v2,M+138,y+5.5,{b:true,s:8.5});y+=8;
  });y+=5;
  R(M,y,W-2*M,7,...hc);T('SYSTEM SPECIFICATION',M+3,y+5,{b:true,s:8,c:[255,255,255]});y+=7;
  R(M,y,W-2*M,15,232,241,255);T('System:',M+3,y+7,{s:8,c:[100,100,130]});T(d.kWp+' kWp',M+38,y+12,{b:true,s:20,c:[255,107,0]});T(d.panels+' Panels x '+SC.panelWatt+'Wp | '+panel,M+85,y+7,{s:8.5});T('Annual: '+d.gen.toLocaleString()+' kWh/yr',M+85,y+13,{b:true,s:9,c:hc});y+=17;
  [[panel,'25yr Warranty','Panel','Warranty'],[inv,'10yr Warranty','Inverter','Warranty'],['GI Galvanized','10yr Warranty','Structure','Warranty'],[phase==='three'?'3-Phase':'1-Phase','5yr Workmanship','Phase','Installation'],['80% at Year 25','Bi-dir meter','Performance','Net Metering']].forEach(([v1,v2,l1,l2],i)=>{
    R(M,y,W-2*M,7.5,i%2===0?245:255,i%2===0?246:255,i%2===0?248:255);L(M,y+7.5,W-M,y+7.5);
    T(l1,M+3,y+5,{s:8,c:[120,120,120]});T(v1,M+48,y+5,{s:8.5});T(l2,M+108,y+5,{s:8,c:[120,120,120]});T(v2,M+148,y+5,{s:8.5});y+=7.5;
  });y+=5;
  R(M,y,W-2*M,7,255,107,0);T('COST BREAKDOWN',M+3,y+5,{b:true,s:8,c:[255,255,255]});y+=7;
  R(M,y,W-2*M,8,245,246,248);T('Gross System Cost',M+3,y+5.5,{s:8.5});T(inr(d.gross),W-M-3,y+5.5,{b:true,s:8.5,a:'right'});y+=8;
  if(d.sub>0){R(M,y,W-2*M,8,220,250,230);T('(-) MNRE Subsidy',M+3,y+5.5,{s:8.5,c:[27,153,71]});T('- '+inr(d.sub),W-M-3,y+5.5,{b:true,s:8.5,c:[27,153,71],a:'right'});y+=8;}
  if(d.disc>0){R(M,y,W-2*M,8,220,250,230);T('(-) Discount',M+3,y+5.5,{s:8.5,c:[27,153,71]});T('- '+inr(d.disc),W-M-3,y+5.5,{b:true,s:8.5,c:[27,153,71],a:'right'});y+=8;}
  L(M,y,W-M,y,...hc,1);R(M,y,W-2*M,13,255,243,220);T('NET PAYABLE (incl. GST)',M+3,y+9,{b:true,s:10.5});T(inr(d.net),W-M-3,y+9,{b:true,s:14,c:[255,107,0],a:'right'});y+=17;y+=4;
  R(M,y,W-2*M,7,27,110,65);T('FINANCIAL ANALYSIS (25 Years)',M+3,y+5,{b:true,s:8,c:[255,255,255]});y+=7;
  [['Tariff',inr(d.tariff)+'/kWh','CO2',d.co2+'t/yr'],['Self-Use',d.self.toLocaleString()+' kWh','Trees',Math.round(d.co2*45)+'/yr'],['Export',d.expU.toLocaleString()+' kWh','Savings/yr',inr(d.sav)],['Maintenance',inr(d.maint),'Net Savings/yr',inr(d.netSav)],['Payback',d.pb+' Yrs','25yr Savings',inr(d.life)],['25yr ROI',d.roi+'%','Investment',inr(d.net)]].forEach(([l1,v1,l2,v2],i)=>{
    const last=i===5;R(M,y,W-2*M,8,last?220:i%2===0?245:255,last?250:i%2===0?246:255,last?230:i%2===0?248:255);L(M,y+8,W-M,y+8);
    T(l1,M+3,y+5.5,{s:8,c:[120,120,120]});T(v1,M+50,y+5.5,{b:last,s:last?9:8.5,c:last?[27,153,71]:[30,30,30]});
    T(l2,M+108,y+5.5,{s:8,c:[120,120,120]});T(v2,W-M-3,y+5.5,{b:last,s:last?9:8.5,c:last?[27,153,71]:[30,30,30],a:'right'});y+=8;
  });y+=5;
  R(M,y,W-2*M,7,...hc);T('NET METERING INFO',M+3,y+5,{b:true,s:8,c:[255,255,255]});y+=7;
  R(M,y,W-2*M,20,232,241,255);T(state+': '+nm,M+3,y+5,{b:true,s:7.5,c:hc});T('Subsidy: 2kW=30k | 3kW=60k | >3kW=78k (MNRE PM-Surya Ghar)',M+3,y+11,{s:7.5});T('Subsidy via DBT after DISCOM inspection. Bi-directional meter by DISCOM.',M+3,y+17,{s:7.5});y+=23;
  R(M,y,W-2*M,7,255,107,0);T('PAYMENT TERMS',M+3,y+5,{b:true,s:8,c:[255,255,255]});y+=7;
  R(M,y,W-2*M,14,255,243,220);T(payment,M+3,y+5.5,{s:8.5});T('Scope: Supply, Install, Commission, DISCOM & Subsidy Processing',M+3,y+11.5,{s:8});y+=17;
  L(M,y+12,M+65,y+12);L(W-M-65,y+12,W-M,y+12);T('Authorized Signatory',M,y+16,{s:8,c:[130,130,130]});T(company,M,y+21,{b:true,s:8.5});T('Customer Signature',W-M,y+16,{s:8,c:[130,130,130],a:'right'});T(name,W-M,y+21,{b:true,s:8.5,a:'right'});y+=26;
  doc.setFontSize(7);doc.setTextColor(160,160,160);const lines=doc.splitTextToSize('Terms: '+terms,W-2*M);doc.text(lines,M,y);y+=8;L(M,y,W-M,y);
  const footer=currentTemplate.footer||'SolarQuote Pro India';
  T(footer+' | '+qno,W/2,y+5,{s:7,c:[180,180,180],a:'center'});
  doc.save('SolarQuote_'+(name||'Quote').replace(/[^a-zA-Z0-9]/g,'_')+'_'+qno+'.pdf');
}
</script>
</body>
</html>
